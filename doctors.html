<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Prince Alex Hospital - Doctor Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:"Poppins",sans-serif}
    body{display:flex;min-height:100vh;background:#f4f7fa}
    .sidebar{width:220px;background:#004085;color:#fff;display:flex;flex-direction:column;padding:20px}
    .sidebar h2{font-size:20px;margin-bottom:18px;text-align:center}
    .sidebar a{color:#fff;text-decoration:none;padding:10px;border-radius:8px;margin:6px 0;display:block}
    .sidebar a:hover{background:#0657b8}
    .main{flex:1;padding:20px}
    .topbar{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:12px 18px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.08);margin-bottom:18px}
    .topbar h1{color:#004085;font-size:20px}
    .topbar .meta{color:#334155;font-size:13px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:12px;text-align:left;background:#fff}
    th{background:#004085;color:#fff}
    tr{border-radius:8px;transition:0.15s}
    tr:hover{background:#f1f8ff}
    .badge{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:600;font-size:12px}
    .badge.triaged{background:#e6fffa;color:#065f46}
    .badge.notriage{background:#fff7ed;color:#92400e}
    .badge.labready{background:#dcfce7;color:#166534}
    .actions button{margin-right:8px;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;color:#fff}
    .start-btn{background:#0ea5a4}
    .view-btn{background:#2563eb}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1000}
    .modal-content{background:#fff;width:520px;max-width:96%;max-height:84vh;overflow-y:auto;border-radius:12px;padding:20px;box-shadow:0 6px 30px rgba(2,6,23,0.3)}
    .modal-content h2{color:#004085;margin-bottom:8px;text-align:center}
    .field{margin-bottom:10px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px}
    .row .col{flex:1}
    .modal-actions{display:flex;gap:10px;margin-top:12px}
    .btn{padding:10px;border-radius:8px;border:none;cursor:pointer;color:#fff}
    .btn.primary{background:#004085}
    .btn.secondary{background:#6b7280}
    .small-muted{font-size:13px;color:#475569;margin-top:6px}
    .toast{position:fixed;right:20px;top:20px;padding:12px 16px;border-radius:8px;color:#fff;display:none;z-index:1100}
    .toast.success{background:#16a34a}
    .toast.error{background:#dc2626}
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Prince Alex</h2>
    <a href="index.html">üè† Dashboard</a>
    <a href="patients.html">üßë‚Äçü§ù Patients</a>
    <a href="doctors.html" style="background:rgba(255,255,255,0.06);">üë®‚Äç‚öïÔ∏è Doctors</a>
    <a href="triage.html">ü©∫ Triage</a>
    <a href="lab.html">üß™ Lab</a>
    <a href="pharmacy.html">üíä Pharmacy</a>
    <a href="billing.html">üíµ Billing</a>
    <a href="#" onclick="logout()">üö™ Logout</a>
  </div>

  <div class="main">
    <div class="topbar">
      <div>
        <h1>Doctor Dashboard</h1>
        <div class="small-muted">See incoming patients from triage and completed lab results</div>
      </div>
      <div class="meta" id="userMeta">Welcome</div>
    </div>

    <section>
      <table id="patientsTable">
        <thead>
          <tr>
            <th>Patient</th>
            <th>Triage</th>
            <th>Complaint</th>
            <th>Doctor Notes</th>
            <th>Next Step</th>
            <th>Lab Results</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <!-- Modal: View / Action Patient -->
  <div class="modal" id="viewModal">
    <div class="modal-content">
      <h2>Patient Details & Actions</h2>
      <div id="viewContent"></div>

      <div class="field">
        <label>Doctor Notes / Diagnosis:</label>
        <textarea id="modalDoctorNotes" placeholder="Enter notes here..."></textarea>
      </div>
      <div class="field">
        <label>Prescribed Medicines:</label>
        <textarea id="modalMedicines" placeholder="Enter medicines here..."></textarea>
      </div>
      <div class="field">
        <label>Next Step:</label>
        <select id="modalNextStep">
          <option value="">Select next step</option>
          <option value="Pharmacy">Send to Pharmacy</option>
          <option value="Billing">Send to Billing</option>
          <option value="Discharge">Discharge</option>
          <option value="Refer">Refer / Other Department</option>
        </select>
      </div>

      <div class="modal-actions">
        <button class="btn secondary" onclick="closeView()">Cancel</button>
        <button class="btn primary" onclick="saveAction()">Save Action</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const getLS = (k) => JSON.parse(localStorage.getItem(k) || '[]');
    const setLS = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const userMeta = document.getElementById('userMeta');
    const patientsTableBody = document.querySelector('#patientsTable tbody');
    const toast = document.getElementById('toast');
    const viewModal = document.getElementById('viewModal');
    const viewContent = document.getElementById('viewContent');

    let patients = getLS('patients');
    let labRequests = getLS('labRequests');
    let currentPatientIndex = -1;

    const logged = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
    userMeta.innerText = logged ? `Dr / Staff: ${logged.username} ‚Äî ${logged.department}` : 'Doctor';

    function showToast(msg, type='success') {
      toast.innerText = msg;
      toast.className = 'toast ' + (type==='error' ? 'error' : 'success');
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display = 'none', 2600);
    }

    function renderTable() {
      patients = getLS('patients');
      labRequests = getLS('labRequests');
      patientsTableBody.innerHTML = '';

      if (patients.length === 0) {
        patientsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#9b1c1c">No patients found</td></tr>';
        return;
      }

      patients.forEach((p,i)=>{
        const labForPatient = labRequests.find(lr => lr.patientName === p.name && lr.status === 'completed');
        const labBadge = labForPatient ? '<span class="badge labready">Ready</span>' : '-';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${p.name}</strong><div class="small-muted">${p.age} yrs</div></td>
          <td>${p.triage ? p.triage.temperature+"¬∞C, BP:"+p.triage.bloodPressure : "Not triaged"}</td>
          <td>${p.triage ? p.triage.complaint : "-"}</td>
          <td>${p.doctor ? p.doctor.diagnosis : "-"}</td>
          <td>${p.doctor ? p.doctor.nextStep : "-"}</td>
          <td>${labBadge}</td>
          <td>
            <button class="view-btn" onclick="viewPatient(${i})">View / Action</button>
          </td>
        `;
        patientsTableBody.appendChild(tr);
      });
    }

    function viewPatient(i) {
      currentPatientIndex = i;
      const p = patients[i];

      let out = `
        <p><strong>Name:</strong> ${p.name}</p>
        <p><strong>Age:</strong> ${p.age}</p>
        <p><strong>Contact:</strong> ${p.contact || '-'}</p>
        <hr>
        <h3>Triage</h3>
        <p>${p.triage ? JSON.stringify(p.triage) : "Not triaged"}</p>
        <hr>
        <h3>Lab Results</h3>
      `;

      const labForPatient = labRequests.filter(lr => lr.patientName === p.name && lr.status === 'completed');
      if (labForPatient.length) {
        labForPatient.forEach(lr => {
          out += `<p><strong>Tests:</strong> ${lr.tests.join(", ")}</p>`;
          out += `<p><strong>Results:</strong></p><ul>`;
          for (const [test, res] of Object.entries(lr.results)) {
            out += `<li>${test}: ${res}</li>`;
          }
          out += `</ul><p><em>Completed at ${lr.completedAt}</em></p><hr>`;
        });
      } else {
        out += `<p>No lab results yet</p>`;
      }

      viewContent.innerHTML = out;

      // Populate doctor fields
      document.getElementById('modalDoctorNotes').value = p.doctor ? p.doctor.diagnosis || '' : '';
      document.getElementById('modalMedicines').value = p.doctor ? p.doctor.medicines || '' : '';
      document.getElementById('modalNextStep').value = p.doctor ? p.doctor.nextStep || '' : '';

      viewModal.style.display = 'flex';
    }

    function saveAction() {
      if (currentPatientIndex === -1) return showToast('No patient selected', 'error');
      const p = patients[currentPatientIndex];

      p.doctor = {
        diagnosis: document.getElementById('modalDoctorNotes').value.trim(),
        medicines: document.getElementById('modalMedicines').value.trim(),
        nextStep: document.getElementById('modalNextStep').value,
        timestamp: new Date().toISOString(),
        doctor: logged ? logged.username : 'Unknown'
      };

      setLS('patients', patients);
      showToast('Patient action saved successfully');
      closeView();
      renderTable();
    }

    function closeView() {
      viewModal.style.display = 'none';
      currentPatientIndex = -1;
    }

    function logout(){
      localStorage.removeItem('loggedInUser');
      window.location.href='index.html';
    }

    // Show notification if new completed labs
    function notifyNewLabs() {
      const notified = getLS('doctorNotified');
      const completed = labRequests.filter(lr=>lr.status==='completed');
      completed.forEach(lr=>{
        if (!notified.includes(lr.id)) {
          showToast(`Lab results ready for ${lr.patientName}`);
          notified.push(lr.id);
        }
      });
      setLS('doctorNotified', notified);
    }

    if (!localStorage.getItem('doctorNotified')) setLS('doctorNotified',[]);
    renderTable();
    notifyNewLabs();
  </script>
</body>
</html>
