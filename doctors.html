<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Doctor Workflow - Prince Alex Hospital HMS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header h1 {
            font-size: 1.5rem;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            color: #333;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .patient-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .patient-list {
            display: grid;
            gap: 1rem;
        }

        .patient-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 1rem;
            border-left: 4px solid #e5e7eb;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .patient-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .patient-card.selected {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }

        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .patient-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .patient-details {
            font-size: 0.9rem;
            color: #666;
        }

        .urgency-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .urgency-critical {
            background: #fee2e2;
            color: #dc2626;
        }

        .urgency-urgent {
            background: #fef3c7;
            color: #d97706;
        }

        .urgency-non-urgent {
            background: #d1fae5;
            color: #059669;
        }

        .consultation-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .consultation-form {
            display: none;
        }

        .consultation-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .next-step-section {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .next-step-section h4 {
            margin-bottom: 1rem;
            color: #333;
        }

        .next-step-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .next-step-option {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .next-step-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .next-step-option.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .next-step-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .next-step-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .next-step-description {
            font-size: 0.9rem;
            color: #666;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #10b981;
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.warning {
            background: #f59e0b;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .history-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .history-item {
            background: #f8fafc;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #e5e7eb;
        }

        .history-item.consultation {
            border-left-color: #3b82f6;
        }

        .history-item.lab {
            border-left-color: #10b981;
        }

        .history-item.pharmacy {
            border-left-color: #f59e0b;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-type {
            font-weight: 600;
            color: #333;
        }

        .history-date {
            font-size: 0.9rem;
            color: #666;
        }

        .history-content {
            color: #666;
            line-height: 1.5;
        }

        .notification-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 1rem;
            border-left: 4px solid #e5e7eb;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .notification-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .notification-card.unread {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }

        .notification-card.high-priority {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .notification-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .notification-time {
            font-size: 0.9rem;
            color: #666;
        }

        .notification-message {
            color: #666;
            margin-bottom: 0.5rem;
        }

        .notification-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .notification-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .view-results-btn {
            background: #10b981;
            color: white;
        }

        .view-results-btn:hover {
            background: #059669;
        }

        .mark-read-btn {
            background: #6b7280;
            color: white;
        }

        .mark-read-btn:hover {
            background: #4b5563;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .notification-alert {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(59, 130, 246, 0.3);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.5s ease;
            max-width: 350px;
            cursor: pointer;
        }

        .next-step-section {
            margin: 1.5rem 0;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .next-step-section h4 {
            margin: 0 0 1rem 0;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .next-step-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .next-step-option {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
        }

        .next-step-option:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .next-step-option.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .next-step-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .next-step-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .next-step-description {
            font-size: 0.9rem;
            color: #64748b;
        }

        .medicine-section {
            margin: 1.5rem 0;
            padding: 1rem;
            background: #f0f9ff;
            border-radius: 10px;
            border: 1px solid #0ea5e9;
        }

        .medicine-section h4 {
            margin: 0 0 1rem 0;
            color: #0c4a6e;
            font-size: 1.1rem;
        }

        .medicine-form {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .medicines-list {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .medicines-list h5 {
            margin-bottom: 1rem;
            color: #333;
            font-size: 1rem;
        }

        .no-medicines {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 1rem;
        }

        .medicine-item {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .medicine-item:last-child {
            margin-bottom: 0;
        }

        .medicine-details {
            flex: 1;
        }

        .medicine-specs {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .medicine-instructions {
            font-size: 0.8rem;
            color: #059669;
            font-style: italic;
        }

        .medicine-actions {
            display: flex;
            gap: 0.5rem;
        }

        .remove-medicine {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .remove-medicine:hover {
            background: #dc2626;
        }

        .medicine-name {
            font-weight: 600;
            color: #1e293b;
        }

        .medicine-dosage {
            color: #64748b;
            font-size: 0.9rem;
        }

        .medicine-frequency {
            color: #64748b;
            font-size: 0.9rem;
        }

        .medicine-duration {
            color: #64748b;
            font-size: 0.9rem;
        }

        .remove-medicine-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s ease;
        }

        .remove-medicine-btn:hover {
            background: #dc2626;
        }

        .medicines-list {
            margin-top: 1rem;
        }

        .medicines-list h5 {
            margin: 0 0 0.5rem 0;
            color: #1e293b;
            font-size: 1rem;
        }

        .no-medicines {
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 1rem;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .lab-results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            text-align: center;
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .summary-number {
            font-size: 2rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 0.25rem;
        }

        .summary-label {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 500;
        }

        .lab-result-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .lab-result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .lab-result-card.unread {
            border-left: 4px solid #3b82f6;
            background: #f8fafc;
        }

        .lab-result-card.processed {
            border-left: 4px solid #10b981;
            background: #f0fdf4;
        }

        .lab-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .lab-result-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .lab-result-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .lab-result-status.unread {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .lab-result-status.read {
            background: #e5e7eb;
            color: #6b7280;
        }

        .lab-result-status.processed {
            background: #d1fae5;
            color: #059669;
        }

        .lab-result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 0.75rem 0;
        }

        .lab-result-detail {
            display: flex;
            flex-direction: column;
        }

        .lab-result-detail-label {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .lab-result-detail-value {
            font-weight: 600;
            color: #1e293b;
        }

        .lab-result-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .lab-result-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .lab-result-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .lab-result-btn.primary:hover {
            background: #2563eb;
        }

        .lab-result-btn.secondary {
            background: #6b7280;
            color: white;
        }

        .lab-result-btn.secondary:hover {
            background: #4b5563;
        }

        .lab-result-btn.success {
            background: #10b981;
            color: white;
        }

        .lab-result-btn.success:hover {
            background: #059669;
        }

        .history-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .history-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .history-date {
            font-size: 0.9rem;
            color: #64748b;
        }

        .history-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .history-detail {
            font-size: 0.9rem;
            color: #374151;
        }

        .medicine-list {
            margin: 0.5rem 0;
            padding-left: 1rem;
        }

        .medicine-list li {
            margin-bottom: 0.25rem;
            color: #4b5563;
        }

        .result-preview {
            background: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #475569;
            margin-right: 0.5rem;
            display: inline-block;
        }

        .lab-result-card.unread {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .lab-result-card.read {
            border-left: 4px solid #6b7280;
            background: #f9fafb;
        }

        .lab-result-card.processed {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .lab-result-status.unread {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .lab-result-status.read {
            background: #e5e7eb;
            color: #6b7280;
        }

        .lab-result-status.processed {
            background: #d1fae5;
            color: #059669;
        }

        /* Hamburger Menu Styles */
        .hamburger-btn {
            display: none;
            flex-direction: column;
            justify-content: space-around;
            width: 2rem;
            height: 2rem;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            z-index: 1001;
        }

        .hamburger-btn span {
            width: 2rem;
            height: 0.25rem;
            background: white;
            border-radius: 10px;
            transition: all 0.3s linear;
            position: relative;
            transform-origin: 1px;
        }

        .hamburger-btn.active span:first-child {
            transform: rotate(45deg);
        }

        .hamburger-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-btn.active span:nth-child(3) {
            transform: rotate(-45deg);
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: linear-gradient(135deg, #059669, #047857);
            z-index: 1000;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h3 {
            color: white;
            margin: 0;
            font-size: 1.2rem;
        }

        .close-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .sidebar-section {
            margin-bottom: 1.5rem;
        }

        .sidebar-section h4 {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0 0 0.5rem 1.5rem;
            font-weight: 600;
        }

        .sidebar-link, .sidebar-tab {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: white;
            text-decoration: none;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .sidebar-link:hover, .sidebar-tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-tab.active {
            background: rgba(255, 255, 255, 0.2);
            border-right: 3px solid white;
        }

        .sidebar-icon {
            font-size: 1.2rem;
            width: 1.5rem;
            text-align: center;
        }

        .sidebar-logout {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            margin: 0 1.5rem;
            border-radius: 6px;
        }

        .sidebar-logout:hover {
            background: rgba(255, 255, 255, 0.2) !important;
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 768px) {
            .next-step-options {
                grid-template-columns: 1fr;
            }
            
            .medicine-form {
                grid-template-columns: 1fr;
            }
            
            .medicine-item {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .lab-results-summary {
                grid-template-columns: 1fr;
            }

            .lab-result-details {
                grid-template-columns: 1fr;
            }

            .header-actions {
                flex-direction: column;
            }
        }

        .notification-alert.show {
            transform: translateX(0);
        }

        .notification-alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .notification-alert-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .notification-alert-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.8;
        }

        .notification-alert-close:hover {
            opacity: 1;
        }

        .notification-alert-message {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .notification-alert-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .alert-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .alert-btn-primary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .alert-btn-primary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .alert-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .alert-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .test-results {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .test-results h4 {
            margin-bottom: 1rem;
            color: #333;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-name {
            font-weight: 500;
            color: #333;
        }

        .result-value {
            color: #666;
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                justify-content: space-between;
            }

            .header-left h1 {
                font-size: 1.2rem;
                margin: 0;
            }

            .hamburger-btn {
                display: flex;
            }

            .nav-buttons {
                display: none;
            }

            .container {
                padding: 0 1rem;
            }

            .tabs {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .next-step-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <button class="hamburger-btn" id="hamburgerBtn">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <h1>üè• Prince Alex Hospital ‚Äì Hospital Management System (HMS)</h1>
        </div>
        <div class="nav-buttons">
            <a href="dashboard.html" class="nav-btn">Dashboard</a>
            <button class="nav-btn" id="logoutBtn">Logout</button>
        </div>
    </div>

    <!-- Mobile Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Doctor Panel</h3>
            <button class="close-sidebar" id="closeSidebar">√ó</button>
        </div>
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="sidebar-link">
                <span class="sidebar-icon">üè†</span>
                Dashboard
            </a>
            <div class="sidebar-section">
                <h4>Navigation</h4>
                <button class="sidebar-tab" data-tab="consultations">
                    <span class="sidebar-icon">üë®‚Äç‚öïÔ∏è</span>
                    Consultations
                </button>
                <button class="sidebar-tab" data-tab="labResults">
                    <span class="sidebar-icon">üß™</span>
                    Lab Results
                </button>
                <button class="sidebar-tab" data-tab="medicalHistory">
                    <span class="sidebar-icon">üìã</span>
                    Medical History
                </button>
            </div>
            <div class="sidebar-section">
                <h4>Actions</h4>
                <button class="nav-btn sidebar-logout" id="sidebarLogoutBtn">
                    <span class="sidebar-icon">üö™</span>
                    Logout
                </button>
            </div>
        </nav>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="container">
        <div class="page-header">
            <h2 class="page-title">üë®‚Äç‚öïÔ∏è Doctor Workflow</h2>
        </div>

                <div class="tabs">
                    <div class="tab active" data-tab="patients">Patient Queue</div>
                    <div class="tab" data-tab="consultation">Consultation</div>
                    <div class="tab" data-tab="notifications" id="notificationsTab">
                        Lab Results
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </div>
                    <div class="tab" data-tab="history">Medical History</div>
                </div>

        <!-- Patient Queue Tab -->
        <div class="tab-content active" id="patientsTab">
            <div class="patient-section">
                <div class="section-header">
                    <h3 class="section-title">Patients Waiting for Consultation</h3>
                </div>
                <div class="patient-list" id="patientQueue">
                    <div class="loading">Loading patients...</div>
                </div>
            </div>
        </div>

        <!-- Consultation Tab -->
        <div class="tab-content" id="consultationTab">
            <div class="consultation-section">
                <div class="section-header">
                    <h3 class="section-title">Consultation Form</h3>
                </div>
                <div id="noPatientSelected">
                    <div class="empty-state">
                        <h3>No Patient Selected</h3>
                        <p>Please select a patient from the Patient Queue tab to begin consultation</p>
                    </div>
                </div>
                <form class="consultation-form" id="consultationForm">
                    <div class="form-group">
                        <label for="patientInfo">Patient Information</label>
                        <input type="text" id="patientInfo" readonly>
                    </div>
                    <div class="form-group">
                        <label for="symptoms">Symptoms & Presentation *</label>
                        <textarea id="symptoms" required placeholder="Describe the patient's symptoms and presentation"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="diagnosis">Diagnosis</label>
                        <textarea id="diagnosis" placeholder="Enter your diagnosis"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="treatment">Treatment Plan</label>
                        <textarea id="treatment" placeholder="Describe the treatment plan"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="notes">Additional Notes</label>
                        <textarea id="notes" placeholder="Any additional observations or notes"></textarea>
                    </div>

                    <div class="next-step-section">
                        <h4>Next Step</h4>
                        <div class="next-step-options">
                            <div class="next-step-option" data-step="lab">
                                <div class="next-step-icon">üß™</div>
                                <div class="next-step-title">Send to Lab</div>
                                <div class="next-step-description">Request laboratory tests</div>
                            </div>
                            <div class="next-step-option" data-step="pharmacy">
                                <div class="next-step-icon">üíä</div>
                                <div class="next-step-title">Send to Pharmacy</div>
                                <div class="next-step-description">Prescribe medications</div>
                            </div>
                            <div class="next-step-option" data-step="discharge">
                                <div class="next-step-icon">üè†</div>
                                <div class="next-step-title">Discharge</div>
                                <div class="next-step-description">Discharge patient</div>
                            </div>
                            <div class="next-step-option" data-step="followup">
                                <div class="next-step-icon">üìÖ</div>
                                <div class="next-step-title">Follow-up</div>
                                <div class="next-step-description">Schedule follow-up</div>
                            </div>
                        </div>
                    </div>

                    <!-- Medicine Prescription Section (shown when pharmacy is selected) -->
                    <div class="medicine-section" id="medicineSection" style="display: none;">
                        <h4>üíä Prescribe Medications</h4>
                        <div class="medicine-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="medicineName">Medicine Name *</label>
                                    <input type="text" id="medicineName" placeholder="e.g., Amoxicillin" required>
                                </div>
                                <div class="form-group">
                                    <label for="medicineDosage">Dosage *</label>
                                    <input type="text" id="medicineDosage" placeholder="e.g., 500mg" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="medicineFrequency">Frequency *</label>
                                    <select id="medicineFrequency" required>
                                        <option value="">Select Frequency</option>
                                        <option value="Once daily">Once daily</option>
                                        <option value="Twice daily">Twice daily</option>
                                        <option value="Three times daily">Three times daily</option>
                                        <option value="Four times daily">Four times daily</option>
                                        <option value="Every 6 hours">Every 6 hours</option>
                                        <option value="Every 8 hours">Every 8 hours</option>
                                        <option value="Every 12 hours">Every 12 hours</option>
                                        <option value="As needed">As needed</option>
                                        <option value="Before meals">Before meals</option>
                                        <option value="After meals">After meals</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="medicineDuration">Duration *</label>
                                    <select id="medicineDuration" required>
                                        <option value="">Select Duration</option>
                                        <option value="1 day">1 day</option>
                                        <option value="3 days">3 days</option>
                                        <option value="5 days">5 days</option>
                                        <option value="7 days">7 days</option>
                                        <option value="10 days">10 days</option>
                                        <option value="14 days">14 days</option>
                                        <option value="21 days">21 days</option>
                                        <option value="30 days">30 days</option>
                                        <option value="Until finished">Until finished</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="medicineQuantity">Quantity *</label>
                                    <input type="number" id="medicineQuantity" placeholder="e.g., 30" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label for="medicineInstructions">Special Instructions</label>
                                    <input type="text" id="medicineInstructions" placeholder="e.g., Take with food, Avoid alcohol">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="medicineNotes">Doctor's Notes</label>
                                <textarea id="medicineNotes" placeholder="Additional notes about this medication"></textarea>
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addMedicineToPrescription()">Add Medicine</button>
                        </div>
                        
                        <div class="medicines-list" id="medicinesList">
                            <h5>Prescribed Medicines:</h5>
                            <div class="no-medicines" id="noMedicines">No medicines added yet</div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="clearConsultationBtn">Clear Form</button>
                        <button type="button" class="btn btn-primary" id="saveConsultationBtn">
                            <span class="spinner" id="saveSpinner"></span>
                            <span id="saveBtnText">Save Consultation</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

                <!-- Lab Results Tab -->
                <div class="tab-content" id="notificationsTab">
                    <div class="patient-section">
                        <div class="section-header">
                            <h3 class="section-title">üß™ Completed Lab Results</h3>
                            <div class="header-actions">
                                <button class="btn btn-secondary" id="markAllReadBtn">Mark All Read</button>
                                <button class="btn btn-primary" id="refreshLabResultsBtn">Refresh</button>
                                <button class="btn btn-success" onclick="createSampleLabResults()">Create Sample Data</button>
                            </div>
                        </div>
                        <div class="lab-results-summary">
                            <div class="summary-card">
                                <div class="summary-number" id="totalLabResults">0</div>
                                <div class="summary-label">Total Results</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-number" id="unreadLabResults">0</div>
                                <div class="summary-label">Need Review</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-number" id="pendingActionResults">0</div>
                                <div class="summary-label">Pending Action</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-number" id="processedResults">0</div>
                                <div class="summary-label">Completed</div>
                            </div>
                        </div>
                        <div class="patient-list" id="notificationsList">
                            <div class="loading">Loading lab results...</div>
                        </div>
                    </div>
                </div>

        <!-- Patient History Tab -->
        <div class="tab-content" id="historyTab">
            <div class="history-section">
                <div class="section-header">
                    <h3 class="section-title">Patient History</h3>
                </div>
                <div id="historyContent">
                    <div class="empty-state">
                        <h3>No Patient Selected</h3>
                        <p>Please select a patient to view their medical history</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYfTWtl-N21DxVATxVnhCofgQsVu3xK4M",
            authDomain: "store-e88d9.firebaseapp.com",
            projectId: "store-e88d9",
            storageBucket: "store-e88d9.firebasestorage.app",
            messagingSenderId: "30797525855",
            appId: "1:30797525855:web:335287605ec648f747fcea"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let selectedPatient = null;
        let triagePatients = [];
        let consultations = [];
        let notifications = [];
        let labResults = [];
        let labRequests = [];
        let medicalHistory = [];

        // Toast function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Check authentication
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            
            console.log('User authenticated:', user.email);
            loadData();
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabName}Tab`).classList.add('active');
            });
        });

        // Load data
        async function loadData() {
            try {
                console.log('Loading data...');
                
                // Show loading states
                const patientQueue = document.getElementById('patientQueue');
                const notificationsList = document.getElementById('notificationsList');
                const historyContent = document.getElementById('historyContent');
                
                if (patientQueue) patientQueue.innerHTML = '<div class="loading">Loading patients...</div>';
                if (notificationsList) notificationsList.innerHTML = '<div class="loading">Loading lab results...</div>';
                if (historyContent) historyContent.innerHTML = '<div class="loading">Loading medical history...</div>';
                
                // Load triage patients
                const triageSnapshot = await getDocs(collection(db, 'triage'));
                triagePatients = triageSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('Triage patients loaded:', triagePatients.length);

                // Load consultations
                const consultationsSnapshot = await getDocs(collection(db, 'consultations'));
                consultations = consultationsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('Consultations loaded:', consultations.length);

                // Load notifications
                const notificationsSnapshot = await getDocs(collection(db, 'notifications'));
                notifications = notificationsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('Notifications loaded:', notifications.length);

                // Load lab requests
                const labRequestsSnapshot = await getDocs(collection(db, 'labRequests'));
                labRequests = labRequestsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('Lab requests loaded:', labRequests.length);

                // Load lab results
                const labResultsSnapshot = await getDocs(collection(db, 'labResults'));
                labResults = labResultsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('Lab results loaded:', labResults.length);

                // Load medical history (processed cases)
                const medicalHistorySnapshot = await getDocs(collection(db, 'medicalHistory'));
                medicalHistory = medicalHistorySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('Medical history loaded:', medicalHistory.length);

                console.log('Rendering data...');
                renderPatientQueue();
                renderLabResults();
                updateNotificationBadge();
                showNewNotificationsAlert();
                renderMedicalHistory();
                console.log('Data loading completed successfully');
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error loading data: ' + error.message, 'error');
            }
        }

        // Render patient queue
        function renderPatientQueue() {
            const container = document.getElementById('patientQueue');
            
            if (!triagePatients || triagePatients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No patients waiting</h3>
                        <p>All patients have been seen</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = triagePatients.map(patient => `
                <div class="patient-card" data-patient-id="${patient.id}">
                    <div class="patient-header">
                        <div>
                            <div class="patient-name">${patient.patientName}</div>
                            <div class="patient-details">
                                ${patient.patientAge} years, ${patient.patientGender} ‚Ä¢ ${patient.modeOfArrival}
                            </div>
                        </div>
                        <span class="urgency-badge urgency-${patient.urgencyLevel.toLowerCase()}">${patient.urgencyLevel}</span>
                    </div>
                    <div class="patient-details">
                        <strong>Chief Complaint:</strong> ${patient.chiefComplaint}
                    </div>
                    ${patient.temperature || patient.bloodPressure || patient.heartRate || patient.oxygenSaturation ? `
                    <div class="patient-details" style="margin-top: 0.5rem;">
                        <strong>Vitals:</strong> 
                        ${patient.temperature ? `${patient.temperature}¬∞C` : ''}
                        ${patient.bloodPressure ? ` ‚Ä¢ BP: ${patient.bloodPressure}` : ''}
                        ${patient.heartRate ? ` ‚Ä¢ HR: ${patient.heartRate}` : ''}
                        ${patient.oxygenSaturation ? ` ‚Ä¢ O2: ${patient.oxygenSaturation}%` : ''}
                    </div>
                    ` : ''}
                </div>
            `).join('');

            // Add click handlers
            document.querySelectorAll('.patient-card').forEach(card => {
                card.addEventListener('click', () => {
                    const patientId = card.dataset.patientId;
                    selectPatient(patientId);
                });
            });
        }

        // Select patient
        function selectPatient(patientId) {
            selectedPatient = triagePatients.find(p => p.id === patientId);
            
            // Update UI
            document.querySelectorAll('.patient-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-patient-id="${patientId}"]`).classList.add('selected');
            
            // Update consultation form
            document.getElementById('patientInfo').value = 
                `${selectedPatient.patientName} (${selectedPatient.patientAge} years, ${selectedPatient.patientGender})`;
            
            // Show consultation form
            document.getElementById('noPatientSelected').style.display = 'none';
            document.getElementById('consultationForm').classList.add('active');
            
            // Load patient history
            loadPatientHistory();
        }

        // Load patient history
        function loadPatientHistory() {
            if (!selectedPatient) return;
            
            const patientConsultations = consultations.filter(c => c.patientId === selectedPatient.id);
            
            const container = document.getElementById('historyContent');
            
            if (patientConsultations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No consultation history</h3>
                        <p>This patient has no previous consultations</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = patientConsultations.map(consultation => `
                <div class="history-item consultation">
                    <div class="history-header">
                        <span class="history-type">Consultation</span>
                        <span class="history-date">${new Date(consultation.createdAt).toLocaleString()}</span>
                    </div>
                    <div class="history-content">
                        <strong>Symptoms:</strong> ${consultation.symptoms}<br>
                        ${consultation.diagnosis ? `<strong>Diagnosis:</strong> ${consultation.diagnosis}<br>` : ''}
                        ${consultation.treatment ? `<strong>Treatment:</strong> ${consultation.treatment}<br>` : ''}
                        ${consultation.notes ? `<strong>Notes:</strong> ${consultation.notes}<br>` : ''}
                        <strong>Next Step:</strong> ${consultation.nextStep}
                    </div>
                </div>
            `).join('');
        }

        // Next step selection
        document.querySelectorAll('.next-step-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.next-step-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                
                // Show/hide medicine section based on selection
                const medicineSection = document.getElementById('medicineSection');
                if (option.dataset.step === 'pharmacy') {
                    medicineSection.style.display = 'block';
                    // Initialize medicines array for consultation form
                    if (!medicineSection.medicines) medicineSection.medicines = [];
                } else {
                    medicineSection.style.display = 'none';
                }
            });
        });

        // Save consultation
        document.getElementById('saveConsultationBtn').addEventListener('click', async (e) => {
            e.preventDefault(); // Prevent form submission
            
            if (!selectedPatient) {
                showToast('Please select a patient first', 'warning');
                return;
            }

            const symptoms = document.getElementById('symptoms').value;
            const diagnosis = document.getElementById('diagnosis').value;
            const treatment = document.getElementById('treatment').value;
            const notes = document.getElementById('notes').value;
            const selectedStep = document.querySelector('.next-step-option.selected');

            if (!symptoms) {
                showToast('Please enter symptoms', 'warning');
                return;
            }

            if (!selectedStep) {
                showToast('Please select a next step', 'warning');
                return;
            }

            const saveBtn = document.getElementById('saveConsultationBtn');
            const saveSpinner = document.getElementById('saveSpinner');
            const saveBtnText = document.getElementById('saveBtnText');
            
            // Show loading state
            saveBtn.disabled = true;
            saveSpinner.style.display = 'inline-block';
            saveBtnText.textContent = 'Saving...';

            try {
                const consultationData = {
                    patientId: selectedPatient.id,
                    patientName: selectedPatient.patientName,
                    symptoms: symptoms,
                    diagnosis: diagnosis || null,
                    treatment: treatment || null,
                    notes: notes || null,
                    nextStep: selectedStep.dataset.step,
                    createdAt: new Date().toISOString()
                };

                await addDoc(collection(db, 'consultations'), consultationData);
                
                // Handle next step
                await handleNextStep(selectedStep.dataset.step, selectedPatient);
                
                showToast('Consultation saved successfully', 'success');
                
                // Clear form
                document.getElementById('consultationForm').reset();
                document.querySelectorAll('.next-step-option').forEach(opt => opt.classList.remove('selected'));
                
                // Hide medicine section and clear medicines
                const medicineSection = document.getElementById('medicineSection');
                medicineSection.style.display = 'none';
                medicineSection.medicines = [];
                updateMedicinesList(medicineSection);
                
                // Remove patient from triage queue
                triagePatients = triagePatients.filter(p => p.id !== selectedPatient.id);
                renderPatientQueue();
                
                // Reload data
                await loadData();
                
            } catch (error) {
                console.error('Error saving consultation:', error);
                showToast('Error saving consultation', 'error');
            } finally {
                // Reset button state
                saveBtn.disabled = false;
                saveSpinner.style.display = 'none';
                saveBtnText.textContent = 'Save Consultation';
            }
        });

        // Handle next step
        async function handleNextStep(step, patient) {
            switch (step) {
                case 'lab':
                    // Create lab request
                    await addDoc(collection(db, 'labRequests'), {
                        patientId: patient.id,
                        patientName: patient.patientName,
                        requestType: 'General',
                        status: 'Pending',
                        createdAt: new Date().toISOString()
                    });
                    showToast('Lab request created', 'success');
                    break;
                    
                case 'pharmacy':
                    // Get medicines from consultation form
                    const medicineSection = document.getElementById('medicineSection');
                    const medicines = medicineSection.medicines || [];
                    
                    if (medicines.length === 0) {
                        showToast('Please add at least one medicine to the prescription', 'warning');
                        return;
                    }
                    
                    // Create prescription with medicines
                    await addDoc(collection(db, 'prescriptions'), {
                        patientId: patient.id,
                        patientName: patient.patientName,
                        medications: medicines,
                        status: 'Pending',
                        createdAt: new Date().toISOString(),
                        doctorNotes: document.getElementById('notes').value || null
                    });
                    showToast(`Prescription created with ${medicines.length} medicine(s)`, 'success');
                    break;
                    
                case 'discharge':
                    // Create billing record
                    await addDoc(collection(db, 'billing'), {
                        patientId: patient.id,
                        patientName: patient.patientName,
                        services: ['Consultation'],
                        totalAmount: 0,
                        status: 'Pending',
                        createdAt: new Date().toISOString()
                    });
                    showToast('Patient discharged', 'success');
                    break;
                    
                case 'followup':
                    // Create follow-up appointment
                    await addDoc(collection(db, 'appointments'), {
                        patientId: patient.id,
                        patientName: patient.patientName,
                        type: 'Follow-up',
                        status: 'Scheduled',
                        createdAt: new Date().toISOString()
                    });
                    showToast('Follow-up scheduled', 'success');
                    break;
            }
        }

        // Render lab results
        function renderLabResults() {
            const notificationsList = document.getElementById('notificationsList');
            
            // Update summary cards
            updateLabResultsSummary();
            
            // Get ALL completed lab requests and results
            const completedRequests = (labRequests || []).filter(req => req.status === 'Completed');
            const allLabResults = (labResults || []).filter(result => result.status === 'Completed');
            
            // Combine all completed lab data
            const allLabData = [...completedRequests, ...allLabResults];
            
            if (allLabData.length === 0) {
                notificationsList.innerHTML = `
                    <div class="empty-state">
                        <h3>No Lab Results Available</h3>
                        <p>No completed lab tests found. Lab results will appear here once tests are completed.</p>
                        <button class="btn btn-primary" onclick="loadData()">Refresh</button>
                    </div>
                `;
                return;
            }

            // Sort by creation date (newest first)
            const sortedLabData = allLabData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            notificationsList.innerHTML = sortedLabData.map(labItem => {
                // Determine if this is a lab result or a completed request
                const isLabResult = labItem.testResults !== undefined;
                const labResult = isLabResult ? labItem : null;
                const labRequest = !isLabResult ? labItem : null;
                
                // Get the request ID for notifications lookup
                const requestId = labItem.requestId || labItem.id;
                const notification = notifications.find(n => n.requestId === requestId);
                const isProcessed = medicalHistory.some(h => h.labResultId === labItem.id || h.requestId === requestId);
                const status = isProcessed ? 'processed' : (notification?.status === 'unread' ? 'unread' : 'read');
                const statusIcon = isProcessed ? '‚úÖ' : (notification?.status === 'unread' ? 'üîî' : 'üëÅÔ∏è');
                const statusText = isProcessed ? 'Action Taken' : (notification?.status === 'unread' ? 'Needs Review' : 'Reviewed');
                
                // Get display data
                const patientName = labItem.patientName || 'Unknown Patient';
                const testType = labItem.testType || labItem.requestType || 'Lab Test';
                const createdAt = labItem.createdAt || new Date().toISOString();
                const labNotes = labItem.labNotes || '';
                const testResults = labItem.testResults || {};
                
                return `
                    <div class="lab-result-card ${status}">
                        <div class="lab-result-header">
                            <div class="lab-result-title">
                                ${statusIcon} ${testType} - ${patientName}
                            </div>
                            <div class="lab-result-status ${status}">${statusText}</div>
                        </div>
                        
                        <div class="lab-result-details">
                            <div class="lab-result-detail">
                                <div class="lab-result-detail-label">Patient</div>
                                <div class="lab-result-detail-value">${patientName}</div>
                            </div>
                            <div class="lab-result-detail">
                                <div class="lab-result-detail-label">Test Type</div>
                                <div class="lab-result-detail-value">${testType}</div>
                            </div>
                            <div class="lab-result-detail">
                                <div class="lab-result-detail-label">Completed</div>
                                <div class="lab-result-detail-value">${new Date(createdAt).toLocaleString()}</div>
                            </div>
                            <div class="lab-result-detail">
                                <div class="lab-result-detail-label">Lab Status</div>
                                <div class="lab-result-detail-value">${labItem.status || 'Completed'}</div>
                            </div>
                        </div>

                        ${labNotes ? `
                            <div class="lab-result-detail">
                                <div class="lab-result-detail-label">Lab Notes</div>
                                <div class="lab-result-detail-value">${labNotes}</div>
                            </div>
                        ` : ''}

                        ${Object.keys(testResults).length > 0 ? `
                            <div class="lab-result-detail">
                                <div class="lab-result-detail-label">Key Results</div>
                                <div class="lab-result-detail-value">
                                    ${Object.entries(testResults).slice(0, 3).map(([name, value]) => 
                                        `<span class="result-preview">${name}: ${value}</span>`
                                    ).join(' ‚Ä¢ ')}
                                    ${Object.keys(testResults).length > 3 ? '...' : ''}
                                </div>
                            </div>
                        ` : ''}

                        <div class="lab-result-actions">
                            ${!isProcessed ? `
                                <button class="lab-result-btn primary" onclick="viewLabResultsWithNextStep('${requestId}', '${labItem.patientId}', '${patientName}')">
                                    üîç Review & Take Action
                                </button>
                            ` : `
                                <button class="lab-result-btn success" onclick="viewLabResultsWithNextStep('${requestId}', '${labItem.patientId}', '${patientName}')">
                                    üìã View Action Taken
                                </button>
                            `}
                            
                            ${Object.keys(testResults).length > 0 ? `
                                <button class="lab-result-btn secondary" onclick="viewLabResults('${requestId}')">
                                    üìä View Full Results
                                </button>
                            ` : `
                                <button class="lab-result-btn secondary" onclick="viewLabRequestDetails('${labItem.id}')">
                                    üìã View Request Details
                                </button>
                            `}
                            
                            ${notification && notification.status === 'unread' && !isProcessed ? `
                                <button class="lab-result-btn secondary" onclick="markNotificationRead('${notification.id}')">
                                    ‚úì Mark as Read
                                </button>
                            ` : ''}
                            
                            ${isProcessed ? `
                                <button class="lab-result-btn success" onclick="viewMedicalHistory('${labItem.patientId}')">
                                    üìö View Patient History
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update lab results summary
        function updateLabResultsSummary() {
            // Get ALL completed lab requests and results
            const completedRequests = (labRequests || []).filter(req => req.status === 'Completed');
            const allLabResults = (labResults || []).filter(result => result.status === 'Completed');
            const allLabData = [...completedRequests, ...allLabResults];
            
            const totalResults = allLabData.length;
            const unreadResults = (notifications || []).filter(n => n.status === 'unread' && n.type === 'lab_completed').length;
            const pendingActionResults = allLabData.filter(item => 
                !(medicalHistory || []).some(h => h.labResultId === item.id || h.requestId === item.requestId)
            ).length;
            const processedResults = totalResults - pendingActionResults;

            const totalElement = document.getElementById('totalLabResults');
            const unreadElement = document.getElementById('unreadLabResults');
            const pendingElement = document.getElementById('pendingActionResults');

            if (totalElement) {
                totalElement.textContent = totalResults;
                totalElement.parentElement.querySelector('.summary-label').textContent = 'Total Results';
            }
            if (unreadElement) {
                unreadElement.textContent = unreadResults;
                unreadElement.parentElement.querySelector('.summary-label').textContent = 'Need Review';
            }
            if (pendingElement) {
                pendingElement.textContent = pendingActionResults;
                pendingElement.parentElement.querySelector('.summary-label').textContent = 'Pending Action';
            }

            // Add processed count if we have a fourth card
            const processedElement = document.getElementById('processedResults');
            if (processedElement) {
                processedElement.textContent = processedResults;
            }
        }

        // Update notification badge
        function updateNotificationBadge() {
            const unreadCount = (notifications || []).filter(n => n.status === 'unread').length;
            const badge = document.getElementById('notificationBadge');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // Show prominent notification alert for new lab results
        function showNewNotificationsAlert() {
            const unreadNotifications = notifications.filter(n => n.status === 'unread' && n.type === 'lab_completed');
            
            if (unreadNotifications.length > 0) {
                // Remove any existing alerts
                const existingAlert = document.querySelector('.notification-alert');
                if (existingAlert) {
                    existingAlert.remove();
                }
                
                const latestNotification = unreadNotifications[0]; // Most recent
                
                const alert = document.createElement('div');
                alert.className = 'notification-alert';
                alert.innerHTML = `
                    <div class="notification-alert-header">
                        <div class="notification-alert-title">üîî New Lab Results Ready!</div>
                        <button class="notification-alert-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="notification-alert-message">
                        Lab test results for <strong>${latestNotification.patientName}</strong> are ready for review.
                    </div>
                    <div class="notification-alert-actions">
                        <button class="alert-btn alert-btn-primary" onclick="viewLabResultsWithNextStep('${latestNotification.requestId}', '${latestNotification.patientId}', '${latestNotification.patientName}'); this.parentElement.parentElement.remove();">
                            Review & Decide
                        </button>
                        <button class="alert-btn alert-btn-secondary" onclick="document.querySelector('[data-tab=\\"notifications\\"]').click(); this.parentElement.parentElement.remove();">
                            View All
                        </button>
                    </div>
                `;
                
                document.body.appendChild(alert);
                
                // Show the alert
                setTimeout(() => {
                    alert.classList.add('show');
                }, 100);
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    if (alert.parentElement) {
                        alert.classList.remove('show');
                        setTimeout(() => {
                            if (alert.parentElement) {
                                alert.remove();
                            }
                        }, 500);
                    }
                }, 10000);
            }
        }

        // View lab results with next step decision
        window.viewLabResultsWithNextStep = async function(requestId, patientId, patientName) {
            try {
                // Load lab results for this request
                const labResultsSnapshot = await getDocs(collection(db, 'labResults'));
                const labResults = labResultsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const labResult = labResults.find(result => result.requestId === requestId);
                if (labResult) {
                    // Show lab results with next step decision modal
                    showLabResultsWithNextStepModal(labResult, patientId, patientName);
                } else {
                    showToast('Lab results not found', 'warning');
                }
            } catch (error) {
                console.error('Error loading lab results:', error);
                showToast('Error loading lab results', 'error');
            }
        };

        // View lab results (view only)
        window.viewLabResults = async function(requestId) {
            try {
                // Load lab results for this request
                const labResultsSnapshot = await getDocs(collection(db, 'labResults'));
                const labResults = labResultsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const labResult = labResults.find(result => result.requestId === requestId);
                if (labResult) {
                    // Show lab results in a modal
                    showLabResultsModal(labResult);
                } else {
                    showToast('Lab results not found', 'warning');
                }
            } catch (error) {
                console.error('Error loading lab results:', error);
                showToast('Error loading lab results', 'error');
            }
        };

        // Add medicine to prescription
        window.addMedicineToPrescription = function() {
            // Check if we're in a modal or consultation form
            const container = document.querySelector('.modal.show') || document.getElementById('medicineSection');
            const name = container.querySelector('#medicineName').value.trim();
            const dosage = container.querySelector('#medicineDosage').value.trim();
            const frequency = container.querySelector('#medicineFrequency').value;
            const duration = container.querySelector('#medicineDuration').value;
            const quantity = container.querySelector('#medicineQuantity') ? container.querySelector('#medicineQuantity').value : '1';
            const instructions = container.querySelector('#medicineInstructions') ? container.querySelector('#medicineInstructions').value.trim() : '';
            const notes = container.querySelector('#medicineNotes') ? container.querySelector('#medicineNotes').value.trim() : '';

            if (!name || !dosage || !frequency || !duration) {
                showToast('Please fill in all required medicine fields', 'warning');
                return;
            }

            // Add to medicines array
            if (!container.medicines) container.medicines = [];
            container.medicines.push({
                name: name,
                dosage: dosage,
                frequency: frequency,
                duration: duration,
                quantity: quantity,
                instructions: instructions,
                notes: notes
            });

            // Clear form
            container.querySelector('#medicineName').value = '';
            container.querySelector('#medicineDosage').value = '';
            container.querySelector('#medicineFrequency').value = '';
            container.querySelector('#medicineDuration').value = '';
            if (container.querySelector('#medicineQuantity')) container.querySelector('#medicineQuantity').value = '';
            if (container.querySelector('#medicineInstructions')) container.querySelector('#medicineInstructions').value = '';
            if (container.querySelector('#medicineNotes')) container.querySelector('#medicineNotes').value = '';

            // Update medicines list display
            updateMedicinesList(container);
            showToast('Medicine added to prescription', 'success');
        };

        // Update medicines list display
        function updateMedicinesList(container) {
            const medicinesList = container.querySelector('#medicinesList');
            const noMedicines = container.querySelector('#noMedicines');
            
            if (!container.medicines || container.medicines.length === 0) {
                if (noMedicines) noMedicines.style.display = 'block';
                medicinesList.innerHTML = `
                    <h5>Prescribed Medicines:</h5>
                    <div class="no-medicines" id="noMedicines">No medicines added yet</div>
                `;
                return;
            }

            if (noMedicines) noMedicines.style.display = 'none';
            medicinesList.innerHTML = `
                <h5>Prescribed Medicines:</h5>
                ${container.medicines.map((medicine, index) => `
                    <div class="medicine-item">
                        <div class="medicine-details">
                            <div class="medicine-name">${medicine.name}</div>
                            <div class="medicine-specs">${medicine.dosage} ‚Ä¢ ${medicine.frequency} ‚Ä¢ ${medicine.duration}</div>
                            ${medicine.quantity ? `<div class="medicine-specs">Quantity: ${medicine.quantity}</div>` : ''}
                            ${medicine.instructions ? `<div class="medicine-instructions">${medicine.instructions}</div>` : ''}
                            ${medicine.notes ? `<div class="medicine-instructions">Notes: ${medicine.notes}</div>` : ''}
                        </div>
                        <div class="medicine-actions">
                            <button class="remove-medicine" onclick="removeMedicineFromPrescription(${index})">Remove</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // Remove medicine from prescription
        window.removeMedicineFromPrescription = function(index) {
            const container = document.querySelector('.modal.show') || document.getElementById('medicineSection');
            if (container.medicines && container.medicines[index]) {
                container.medicines.splice(index, 1);
                updateMedicinesList(container);
                showToast('Medicine removed from prescription', 'success');
            }
        };

        // Process next step from notification
        window.processNextStepFromNotification = async function(patientId, patientName, labResultId) {
            const modal = document.querySelector('.modal.show');
            const selectedStep = modal.querySelector('.next-step-option.selected');
            const notes = modal.querySelector('#nextStepNotes').value;

            if (!selectedStep) {
                showToast('Please select a next step', 'warning');
                return;
            }

            try {
                const nextStep = selectedStep.dataset.step;
                
                // Process the next step based on selection
                switch (nextStep) {
                    case 'pharmacy':
                        const medicines = modal.medicines || [];
                        if (medicines.length === 0) {
                            showToast('Please add at least one medicine to the prescription', 'warning');
                            return;
                        }
                        
                        await addDoc(collection(db, 'prescriptions'), {
                            patientId: patientId,
                            patientName: patientName,
                            medications: medicines,
                            status: 'Pending',
                            notes: notes || null,
                            createdAt: new Date().toISOString()
                        });
                        showToast(`Patient sent to pharmacy with ${medicines.length} medicine(s)`, 'success');
                        break;
                        
                    case 'discharge':
                        await addDoc(collection(db, 'billing'), {
                            patientId: patientId,
                            patientName: patientName,
                            services: ['Consultation', 'Lab Test'],
                            totalAmount: 0,
                            status: 'Pending',
                            notes: notes || null,
                            createdAt: new Date().toISOString()
                        });
                        showToast('Patient discharged', 'success');
                        break;
                        
                    case 'followup':
                        await addDoc(collection(db, 'appointments'), {
                            patientId: patientId,
                            patientName: patientName,
                            type: 'Follow-up',
                            status: 'Scheduled',
                            notes: notes || null,
                            createdAt: new Date().toISOString()
                        });
                        showToast('Follow-up appointment scheduled', 'success');
                        break;
                        
                    case 'additional_tests':
                        await addDoc(collection(db, 'labRequests'), {
                            patientId: patientId,
                            patientName: patientName,
                            requestType: 'Additional Tests',
                            status: 'Pending',
                            notes: notes || null,
                            createdAt: new Date().toISOString()
                        });
                        showToast('Additional lab tests requested', 'success');
                        break;
                }

                // Close modal
                modal.remove();
                
                // Mark related notifications as read
                const relatedNotifications = notifications.filter(n => 
                    n.patientId === patientId && n.type === 'lab_completed'
                );
                
                for (const notification of relatedNotifications) {
                    await updateDoc(doc(db, 'notifications', notification.id), {
                        status: 'read',
                        readAt: new Date().toISOString()
                    });
                }

                // Add to medical history
                await addDoc(collection(db, 'medicalHistory'), {
                    patientId: patientId,
                    patientName: patientName,
                    labResultId: labResultId,
                    nextStep: nextStep,
                    medicines: medicines || [],
                    notes: notes || null,
                    processedAt: new Date().toISOString(),
                    processedBy: auth.currentUser?.email || 'Doctor'
                });
                
                // Refresh data
                await loadData();
                
            } catch (error) {
                console.error('Error processing next step:', error);
                showToast('Error processing next step', 'error');
            }
        };

        // Show lab results modal with next step decision
        function showLabResultsWithNextStepModal(labResult, patientId, patientName) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90vw; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3 class="modal-title">Lab Results & Next Step - ${patientName}</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Patient:</label>
                        <input type="text" value="${patientName}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Test Type:</label>
                        <input type="text" value="${labResult.testType}" readonly>
                    </div>
                    
                    <div class="test-results">
                        <h4>Test Results</h4>
                        ${labResult.testResults ? Object.entries(labResult.testResults).map(([name, value]) => `
                            <div class="result-item">
                                <span class="result-name">${name}</span>
                                <span class="result-value">${value}</span>
                            </div>
                        `).join('') : '<p>No test results recorded</p>'}
                    </div>
                    
                    ${labResult.labNotes ? `
                    <div class="form-group">
                        <label>Lab Notes:</label>
                        <textarea readonly>${labResult.labNotes}</textarea>
                    </div>
                    ` : ''}
                    
                    <div class="next-step-section">
                        <h4>Next Step Decision</h4>
                        <div class="next-step-options">
                            <div class="next-step-option" data-step="pharmacy">
                                <div class="next-step-icon">üíä</div>
                                <div class="next-step-title">Send to Pharmacy</div>
                                <div class="next-step-description">Prescribe medications based on results</div>
                            </div>
                            <div class="next-step-option" data-step="discharge">
                                <div class="next-step-icon">üè†</div>
                                <div class="next-step-title">Discharge Patient</div>
                                <div class="next-step-description">Patient can go home</div>
                            </div>
                            <div class="next-step-option" data-step="followup">
                                <div class="next-step-icon">üìÖ</div>
                                <div class="next-step-title">Schedule Follow-up</div>
                                <div class="next-step-description">Schedule another appointment</div>
                            </div>
                            <div class="next-step-option" data-step="additional_tests">
                                <div class="next-step-icon">üß™</div>
                                <div class="next-step-title">Additional Tests</div>
                                <div class="next-step-description">Request more lab tests</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Medicine Prescription Section (shown when pharmacy is selected) -->
                    <div class="medicine-section" id="medicineSection" style="display: none;">
                        <h4>üíä Prescribe Medications</h4>
                        <div class="medicine-form">
                            <div class="form-group">
                                <label for="medicineName">Medicine Name</label>
                                <input type="text" id="medicineName" placeholder="e.g., Amoxicillin">
                            </div>
                            <div class="form-group">
                                <label for="medicineDosage">Dosage</label>
                                <input type="text" id="medicineDosage" placeholder="e.g., 500mg">
                            </div>
                            <div class="form-group">
                                <label for="medicineFrequency">Frequency</label>
                                <select id="medicineFrequency">
                                    <option value="Once daily">Once daily</option>
                                    <option value="Twice daily">Twice daily</option>
                                    <option value="Three times daily">Three times daily</option>
                                    <option value="Four times daily">Four times daily</option>
                                    <option value="As needed">As needed</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="medicineDuration">Duration</label>
                                <select id="medicineDuration">
                                    <option value="3 days">3 days</option>
                                    <option value="5 days">5 days</option>
                                    <option value="7 days">7 days</option>
                                    <option value="10 days">10 days</option>
                                    <option value="14 days">14 days</option>
                                    <option value="30 days">30 days</option>
                                </select>
                            </div>
                            <button class="btn btn-secondary" onclick="addMedicineToPrescription()">Add Medicine</button>
                        </div>
                        
                        <div class="medicines-list" id="medicinesList">
                            <h5>Prescribed Medicines:</h5>
                            <div class="no-medicines" id="noMedicines">No medicines added yet</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="nextStepNotes">Notes for Next Step</label>
                        <textarea id="nextStepNotes" placeholder="Add any notes about the decision or instructions"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                        <button class="btn btn-primary" onclick="processNextStepFromNotification('${patientId}', '${patientName}', '${labResult.id}')">
                            Process Next Step
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add click handlers for next step options
            modal.querySelectorAll('.next-step-option').forEach(option => {
                option.addEventListener('click', () => {
                    modal.querySelectorAll('.next-step-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    
                    // Show/hide medicine section based on selection
                    const medicineSection = modal.querySelector('#medicineSection');
                    if (option.dataset.step === 'pharmacy') {
                        medicineSection.style.display = 'block';
                    } else {
                        medicineSection.style.display = 'none';
                    }
                });
            });
            
            // Initialize medicines array for this modal
            modal.medicines = [];
        }

        // Show lab results modal (view only)
        function showLabResultsModal(labResult) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Lab Results - ${labResult.patientName}</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="form-group">
                        <label>Test Type:</label>
                        <input type="text" value="${labResult.testType}" readonly>
                    </div>
                    <div class="test-results">
                        <h4>Test Results</h4>
                        ${labResult.testResults ? Object.entries(labResult.testResults).map(([name, value]) => `
                            <div class="result-item">
                                <span class="result-name">${name}</span>
                                <span class="result-value">${value}</span>
                            </div>
                        `).join('') : '<p>No test results recorded</p>'}
                    </div>
                    ${labResult.labNotes ? `
                    <div class="form-group">
                        <label>Lab Notes:</label>
                        <textarea readonly>${labResult.labNotes}</textarea>
                    </div>
                    ` : ''}
                    <div class="form-group">
                        <label>Status:</label>
                        <input type="text" value="${labResult.status}" readonly>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Mark notification as read
        window.markNotificationRead = async function(notificationId) {
            try {
                await updateDoc(doc(db, 'notifications', notificationId), {
                    status: 'read',
                    readAt: new Date().toISOString()
                });
                
                // Update local data
                const notificationIndex = notifications.findIndex(n => n.id === notificationId);
                if (notificationIndex !== -1) {
                    notifications[notificationIndex].status = 'read';
                }
                
                renderNotifications();
                updateNotificationBadge();
                showToast('Notification marked as read', 'success');
            } catch (error) {
                console.error('Error marking notification as read:', error);
                showToast('Error updating notification', 'error');
            }
        };

        // Mark all notifications as read
        document.getElementById('markAllReadBtn').addEventListener('click', async () => {
            try {
                const unreadNotifications = notifications.filter(n => n.status === 'unread');
                
                for (const notification of unreadNotifications) {
                    await updateDoc(doc(db, 'notifications', notification.id), {
                        status: 'read',
                        readAt: new Date().toISOString()
                    });
                }
                
                // Update local data
                notifications.forEach(n => {
                    if (n.status === 'unread') {
                        n.status = 'read';
                    }
                });
                
                renderLabResults();
                updateNotificationBadge();
                showToast('All notifications marked as read', 'success');
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                showToast('Error updating notifications', 'error');
            }
        });

        // Refresh lab results
        document.getElementById('refreshLabResultsBtn').addEventListener('click', async () => {
            try {
                showToast('Refreshing lab results...', 'info');
                await loadData();
                showToast('Lab results refreshed', 'success');
            } catch (error) {
                console.error('Error refreshing lab results:', error);
                showToast('Error refreshing lab results', 'error');
            }
        });

        // View lab request details
        window.viewLabRequestDetails = function(requestId) {
            const request = labRequests.find(req => req.id === requestId);
            if (!request) {
                showToast('Lab request not found', 'warning');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Lab Request Details - ${request.patientName}</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Patient:</label>
                        <input type="text" value="${request.patientName}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Test Type:</label>
                        <input type="text" value="${request.requestType || 'Lab Test'}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Requested By:</label>
                        <input type="text" value="${request.requestedBy || 'Doctor'}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Request Date:</label>
                        <input type="text" value="${new Date(request.createdAt).toLocaleString()}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Status:</label>
                        <input type="text" value="${request.status}" readonly>
                    </div>
                    
                    ${request.notes ? `
                    <div class="form-group">
                        <label>Notes:</label>
                        <textarea readonly>${request.notes}</textarea>
                    </div>
                    ` : ''}
                    
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                        <button class="btn btn-primary" onclick="viewLabResultsWithNextStep('${request.id}', '${request.patientId}', '${request.patientName}')">
                            Take Action
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        // Create sample lab results for testing
        window.createSampleLabResults = async function() {
            try {
                // First create some sample lab requests
                const sampleRequests = [
                    {
                        patientId: 'patient004',
                        patientName: 'Emily Davis',
                        requestType: 'Blood Sugar Test',
                        status: 'Completed',
                        requestedBy: 'Dr. Smith',
                        notes: 'Patient reports frequent urination',
                        createdAt: new Date(Date.now() - 1800000).toISOString() // 30 minutes ago
                    },
                    {
                        patientId: 'patient005',
                        patientName: 'Robert Brown',
                        requestType: 'Liver Function Test',
                        status: 'Completed',
                        requestedBy: 'Dr. Johnson',
                        notes: 'Routine checkup',
                        createdAt: new Date(Date.now() - 900000).toISOString() // 15 minutes ago
                    }
                ];

                for (const request of sampleRequests) {
                    await addDoc(collection(db, 'labRequests'), request);
                    
                    // Create notification for each request
                    await addDoc(collection(db, 'notifications'), {
                        type: 'lab_completed',
                        title: 'Lab Request Completed',
                        message: `Lab request for ${request.patientName} has been completed`,
                        patientId: request.patientId,
                        patientName: request.patientName,
                        requestId: request.id,
                        testType: request.requestType,
                        status: 'unread',
                        createdAt: request.createdAt,
                        priority: 'high'
                    });
                }

                // Then create detailed lab results
                const sampleResults = [
                    {
                        patientId: 'patient001',
                        patientName: 'John Smith',
                        requestId: 'req001',
                        testType: 'Complete Blood Count',
                        testResults: {
                            'Hemoglobin': '14.2 g/dL',
                            'White Blood Cells': '7,500/ŒºL',
                            'Platelets': '250,000/ŒºL',
                            'Hematocrit': '42%'
                        },
                        labNotes: 'All values within normal range',
                        status: 'Completed',
                        createdAt: new Date().toISOString()
                    },
                    {
                        patientId: 'patient002',
                        patientName: 'Sarah Johnson',
                        requestId: 'req002',
                        testType: 'Blood Chemistry Panel',
                        testResults: {
                            'Glucose': '95 mg/dL',
                            'Creatinine': '0.9 mg/dL',
                            'BUN': '12 mg/dL',
                            'Cholesterol': '180 mg/dL'
                        },
                        labNotes: 'Slightly elevated cholesterol, recommend dietary changes',
                        status: 'Completed',
                        createdAt: new Date(Date.now() - 3600000).toISOString() // 1 hour ago
                    },
                    {
                        patientId: 'patient003',
                        patientName: 'Mike Wilson',
                        requestId: 'req003',
                        testType: 'Urinalysis',
                        testResults: {
                            'Protein': 'Negative',
                            'Glucose': 'Negative',
                            'Ketones': 'Negative',
                            'Specific Gravity': '1.020'
                        },
                        labNotes: 'Normal urinalysis results',
                        status: 'Completed',
                        createdAt: new Date(Date.now() - 7200000).toISOString() // 2 hours ago
                    }
                ];

                for (const result of sampleResults) {
                    await addDoc(collection(db, 'labResults'), result);
                    
                    // Create notification for each result
                    await addDoc(collection(db, 'notifications'), {
                        type: 'lab_completed',
                        title: 'Lab Test Completed',
                        message: `Lab test results for ${result.patientName} are ready for review`,
                        patientId: result.patientId,
                        patientName: result.patientName,
                        requestId: result.requestId,
                        testType: result.testType,
                        status: 'unread',
                        createdAt: result.createdAt,
                        priority: 'high'
                    });
                }

                showToast(`Sample data created successfully! Created ${sampleRequests.length} lab requests and ${sampleResults.length} lab results.`, 'success');
                await loadData();
            } catch (error) {
                console.error('Error creating sample lab results:', error);
                showToast('Error creating sample lab results', 'error');
            }
        };

        // Render medical history
        function renderMedicalHistory() {
            const historyContent = document.getElementById('historyContent');
            
            if (!medicalHistory || medicalHistory.length === 0) {
                historyContent.innerHTML = `
                    <div class="empty-state">
                        <h3>No medical history</h3>
                        <p>No processed lab results found</p>
                    </div>
                `;
                return;
            }

            // Sort by processing date (newest first)
            const sortedHistory = medicalHistory.sort((a, b) => 
                new Date(b.processedAt) - new Date(a.processedAt)
            );

            historyContent.innerHTML = sortedHistory.map(record => `
                <div class="history-card">
                    <div class="history-header">
                        <div class="history-title">üìã ${record.patientName} - ${record.nextStep}</div>
                        <div class="history-date">${new Date(record.processedAt).toLocaleString()}</div>
                    </div>
                    
                    <div class="history-details">
                        <div class="history-detail">
                            <strong>Patient:</strong> ${record.patientName}
                        </div>
                        <div class="history-detail">
                            <strong>Action Taken:</strong> ${record.nextStep.charAt(0).toUpperCase() + record.nextStep.slice(1)}
                        </div>
                        <div class="history-detail">
                            <strong>Processed By:</strong> ${record.processedBy}
                        </div>
                        ${record.medicines && record.medicines.length > 0 ? `
                            <div class="history-detail">
                                <strong>Medicines Prescribed:</strong>
                                <ul class="medicine-list">
                                    ${record.medicines.map(med => `
                                        <li>${med.name} - ${med.dosage} (${med.frequency} for ${med.duration})</li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${record.notes ? `
                            <div class="history-detail">
                                <strong>Notes:</strong> ${record.notes}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // View medical history for specific patient
        window.viewMedicalHistory = function(patientId) {
            const patientHistory = medicalHistory.filter(h => h.patientId === patientId);
            
            if (patientHistory.length === 0) {
                showToast('No medical history found for this patient', 'warning');
                return;
            }

            // Switch to history tab
            document.querySelector('[data-tab="history"]').click();
            
            // Filter history list to show only this patient
            const historyContent = document.getElementById('historyContent');
            const originalContent = historyContent.innerHTML;
            
            historyContent.innerHTML = patientHistory.map(record => `
                <div class="history-card">
                    <div class="history-header">
                        <div class="history-title">üìã ${record.nextStep}</div>
                        <div class="history-date">${new Date(record.processedAt).toLocaleString()}</div>
                    </div>
                    
                    <div class="history-details">
                        <div class="history-detail">
                            <strong>Action Taken:</strong> ${record.nextStep.charAt(0).toUpperCase() + record.nextStep.slice(1)}
                        </div>
                        <div class="history-detail">
                            <strong>Processed By:</strong> ${record.processedBy}
                        </div>
                        ${record.medicines && record.medicines.length > 0 ? `
                            <div class="history-detail">
                                <strong>Medicines Prescribed:</strong>
                                <ul class="medicine-list">
                                    ${record.medicines.map(med => `
                                        <li>${med.name} - ${med.dosage} (${med.frequency} for ${med.duration})</li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${record.notes ? `
                            <div class="history-detail">
                                <strong>Notes:</strong> ${record.notes}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            // Add back button
            const backButton = document.createElement('button');
            backButton.className = 'btn btn-secondary';
            backButton.textContent = '‚Üê Back to All History';
            backButton.style.marginBottom = '1rem';
            backButton.onclick = () => {
                historyContent.innerHTML = originalContent;
                backButton.remove();
            };
            historyContent.parentNode.insertBefore(backButton, historyContent);
        };

        // Clear consultation form
        document.getElementById('clearConsultationBtn').addEventListener('click', () => {
            document.getElementById('consultationForm').reset();
            document.querySelectorAll('.next-step-option').forEach(opt => opt.classList.remove('selected'));
            
            // Hide medicine section and clear medicines
            const medicineSection = document.getElementById('medicineSection');
            medicineSection.style.display = 'none';
            medicineSection.medicines = [];
            updateMedicinesList(medicineSection);
        });

        // Hamburger Menu and Sidebar Functionality
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const closeSidebar = document.getElementById('closeSidebar');
        const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');

        // Toggle sidebar
        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
            hamburgerBtn.classList.toggle('active');
        }

        // Close sidebar
        function closeSidebarMenu() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
            hamburgerBtn.classList.remove('active');
        }

        // Event listeners for sidebar
        hamburgerBtn.addEventListener('click', toggleSidebar);
        closeSidebar.addEventListener('click', closeSidebarMenu);
        sidebarOverlay.addEventListener('click', closeSidebarMenu);
        sidebarLogoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast('Logged out successfully', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Error logging out', 'error');
            }
        });

        // Sidebar tab switching
        document.querySelectorAll('.sidebar-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active states
                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Switch to the tab content
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                const targetTab = document.querySelector(`[data-tab="${tabName}"]`);
                const targetContent = document.getElementById(`${tabName}Tab`);
                
                if (targetTab) targetTab.classList.add('active');
                if (targetContent) targetContent.classList.add('active');
                
                // Close sidebar on mobile after selection
                if (window.innerWidth <= 768) {
                    closeSidebarMenu();
                }
            });
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast('Logged out successfully', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Error logging out', 'error');
            }
        });
    </script>
</body>
</html>
