<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Prince Alex Hospital - Lab Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:"Poppins",sans-serif}
    body{display:flex;min-height:100vh;background:#f9fafb}
    .sidebar{width:220px;background:#1e3a8a;color:#fff;display:flex;flex-direction:column;padding:20px}
    .sidebar h2{font-size:20px;margin-bottom:18px;text-align:center}
    .sidebar a{color:#fff;text-decoration:none;padding:10px;border-radius:8px;margin:6px 0;display:block}
    .sidebar a:hover{background:#3344aa}
    .main{flex:1;padding:20px}
    .topbar{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:12px 18px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.08);margin-bottom:18px}
    .topbar h1{color:#1e3a8a;font-size:20px}
    .small-muted{font-size:13px;color:#475569}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:12px;text-align:left;background:#fff}
    th{background:#1e3a8a;color:#fff}
    tr:hover{background:#f1f5ff}
    .actions button{margin-right:8px;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;color:#fff}
    .view-btn{background:#2563eb}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1000}
    .modal-content{background:#fff;width:520px;max-width:96%;max-height:84vh;overflow-y:auto;border-radius:12px;padding:20px;box-shadow:0 6px 30px rgba(2,6,23,0.3)}
    .modal-content h2{color:#1e3a8a;margin-bottom:8px;text-align:center}
    .field{margin-bottom:10px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db}
    .test-row{display:flex;gap:8px;margin-bottom:8px}
    .test-row input{flex:1}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn.primary{background:#1e3a8a;color:#fff}
    .btn.secondary{background:#6b7280;color:#fff}
    .add-btn{background:#0ea5a4;color:#fff;margin-bottom:8px}
    .toast{position:fixed;right:20px;top:20px;padding:12px 16px;border-radius:8px;color:#fff;display:none;z-index:1100}
    .toast.success{background:#16a34a}
    .toast.error{background:#dc2626}
    @media(max-width:700px){.modal-content{width:95%}}
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Prince Alex</h2>
    <a href="index.html">üè† Dashboard</a>
    <a href="patients.html">üßë‚Äçü§ù Patients</a>
    <a href="doctors.html">üë®‚Äç‚öïÔ∏è Doctors</a>
    <a href="triage.html">ü©∫ Triage</a>
    <a href="lab.html" style="background:rgba(255,255,255,0.06);">üß™ Lab</a>
    <a href="pharmacy.html">üíä Pharmacy</a>
    <a href="billing.html">üíµ Billing</a>
    <a href="#" onclick="logout()">üö™ Logout</a>
  </div>

  <div class="main">
    <div class="topbar">
      <div>
        <h1>Lab Dashboard</h1>
        <div class="small-muted">Manage lab test requests from doctors</div>
      </div>
      <div id="userMeta" class="small-muted">Lab Tech</div>
    </div>

    <section>
      <table id="labTable">
        <thead>
          <tr>
            <th>Patient</th>
            <th>Requested By</th>
            <th>Tests</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <!-- Modal -->
  <div class="modal" id="labModal">
    <div class="modal-content">
      <h2 id="modalTitle">Lab Results</h2>
      <div class="field">
        <label>Patient:</label>
        <div id="patientName" style="font-weight:600"></div>
      </div>
      <form id="labForm">
        <div id="testsContainer"></div>
        <button type="button" class="btn add-btn" onclick="addCustomTest()">+ Add Test</button>
        <div class="field">
          <label>General Notes</label>
          <textarea id="labNotes" placeholder="Any additional notes..."></textarea>
        </div>
        <div style="display:flex;gap:10px;margin-top:10px">
          <button type="button" class="btn secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn primary">Save Results</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const getLS = (k) => JSON.parse(localStorage.getItem(k) || '[]');
    const setLS = (k,v) => localStorage.setItem(k, JSON.stringify(v));

    const labTableBody = document.querySelector('#labTable tbody');
    const labModal = document.getElementById('labModal');
    const modalTitle = document.getElementById('modalTitle');
    const patientNameEl = document.getElementById('patientName');
    const testsContainer = document.getElementById('testsContainer');
    const labNotesEl = document.getElementById('labNotes');
    const toast = document.getElementById('toast');
    let editIndex = -1;
    let labRequests = getLS('labRequests');
    let patients = getLS('patients'); // ‚úÖ load patients

    const logged = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
    document.getElementById('userMeta').innerText = logged ? `Lab Tech: ${logged.username}` : 'Lab Tech';

    function showToast(msg,type='success'){
      toast.innerText = msg;
      toast.className = 'toast ' + (type==='error'?'error':'success');
      toast.style.display = 'block';
      setTimeout(()=>toast.style.display='none',2500);
    }

    function renderTable(){
      labRequests = getLS('labRequests');
      labTableBody.innerHTML='';
      if(labRequests.length===0){
        labTableBody.innerHTML='<tr><td colspan="5" style="text-align:center;color:#b91c1c">No lab requests found</td></tr>';
        return;
      }
      labRequests.forEach((r,idx)=>{
        const tr=document.createElement('tr');
        const testsList=r.tests && r.tests.length ? r.tests.join(', ') : '-';
        tr.innerHTML=`
          <td>${r.patientName}</td>
          <td>${r.orderedBy}</td>
          <td>${testsList}</td>
          <td>${r.status}</td>
          <td class="actions">
            <button class="view-btn" onclick="openLab(${idx})">View / Update</button>
          </td>`;
        labTableBody.appendChild(tr);
      });
    }

    function openLab(i){
      editIndex=i;
      const r=labRequests[i];
      modalTitle.innerText=`Lab: ${r.patientName}`;
      patientNameEl.innerText=`${r.patientName}`;
      testsContainer.innerHTML='';
      (r.tests && r.tests.length ? r.tests : []).forEach(t=>{
        addTestRow(t,(r.results && r.results[t])||'');
      });
      labNotesEl.value=r.notes||'';
      labModal.style.display='flex';
    }

    function addTestRow(name='',value=''){
      const row=document.createElement('div');
      row.className='test-row';
      row.innerHTML=`
        <input type="text" placeholder="Test name" value="${name}">
        <input type="text" placeholder="Result" value="${value}">
      `;
      testsContainer.appendChild(row);
    }

    function addCustomTest(){ addTestRow('',''); }

    document.getElementById('labForm').addEventListener('submit',e=>{
      e.preventDefault();
      if(editIndex===-1){showToast('No request selected','error');return;}
      const rows=testsContainer.querySelectorAll('.test-row');
      const results={};
      const tests=[];
      rows.forEach(r=>{
        const inputs=r.querySelectorAll('input');
        const tName=inputs[0].value.trim();
        const tVal=inputs[1].value.trim();
        if(tName){tests.push(tName);results[tName]=tVal;}
      });
      const r=labRequests[editIndex];
      r.tests=tests;
      r.results=results;
      r.notes=labNotesEl.value.trim();
      r.status='completed';
      r.completedAt=new Date().toISOString();
      setLS('labRequests',labRequests);

      // ‚úÖ also update patient record
      patients = getLS('patients');
      const patient = patients.find(p => p.id === r.patientId);
      if (patient) {
        patient.labResults = {
          tests: results,
          notes: r.notes,
          status: 'completed',
          completedAt: r.completedAt
        };
        setLS('patients', patients);
      }

      showToast('Lab results saved & attached to patient');
      closeModal();
      renderTable();
    });

    function closeModal(){ labModal.style.display='none'; editIndex=-1; }

    window.addEventListener('click',ev=>{ if(ev.target===labModal) closeModal(); });

    function logout(){
      localStorage.removeItem('loggedInUser');
      window.location.href='index.html';
    }

    renderTable();
  </script>
</body>
</html>
