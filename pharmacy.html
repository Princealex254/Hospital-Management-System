<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Prince Alex Hospital - Pharmacy Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:"Poppins",sans-serif}
    body{display:flex;min-height:100vh;background:#f4f7fa}
    .sidebar{width:220px;background:#004085;color:#fff;display:flex;flex-direction:column;padding:20px}
    .sidebar h2{font-size:20px;margin-bottom:18px;text-align:center}
    .sidebar a{color:#fff;text-decoration:none;padding:10px;border-radius:8px;margin:6px 0;display:block}
    .sidebar a:hover{background:#0657b8}
    .main{flex:1;padding:20px}
    .topbar{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:12px 18px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.08);margin-bottom:18px}
    .topbar h1{color:#004085;font-size:20px}
    .topbar .meta{color:#334155;font-size:13px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:12px;text-align:left;background:#fff}
    th{background:#004085;color:#fff}
    tr{border-radius:8px;transition:0.15s}
    tr:hover{background:#f1f8ff}
    .btn{padding:10px;border-radius:8px;border:none;cursor:pointer;color:#fff}
    .btn.primary{background:#004085}
    .btn.secondary{background:#6b7280}
    .small-muted{font-size:13px;color:#475569;margin-top:6px}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1000}
    .modal-content{background:#fff;width:520px;max-width:96%;max-height:84vh;overflow-y:auto;border-radius:12px;padding:20px;box-shadow:0 6px 30px rgba(2,6,23,0.3)}
    .modal-content h2{color:#004085;margin-bottom:8px;text-align:center}
    .field{margin-bottom:10px}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db}
    .toast{position:fixed;right:20px;top:20px;padding:12px 16px;border-radius:8px;color:#fff;display:none;z-index:1100}
    .toast.success{background:#16a34a}
    .toast.error{background:#dc2626}
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Prince Alex</h2>
    <a href="index.html">üè† Dashboard</a>
    <a href="patients.html">üßë‚Äçü§ù Patients</a>
    <a href="doctors.html">üë®‚Äç‚öïÔ∏è Doctors</a>
    <a href="triage.html">ü©∫ Triage</a>
    <a href="lab.html">üß™ Lab</a>
    <a href="pharmacy.html" style="background:rgba(255,255,255,0.06);">üíä Pharmacy</a>
    <a href="billing.html">üíµ Billing</a>
    <a href="#" onclick="logout()">üö™ Logout</a>
  </div>

  <div class="main">
    <div class="topbar">
      <div>
        <h1>Pharmacy Dashboard</h1>
        <div class="small-muted">Process prescriptions and send patients to billing</div>
      </div>
      <div class="meta" id="userMeta">Welcome</div>
    </div>

    <section>
      <table id="pharmacyTable">
        <thead>
          <tr>
            <th>Patient</th>
            <th>Doctor Notes</th>
            <th>Medicines</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <!-- Modal: Process Prescription -->
  <div class="modal" id="pharmacyModal">
    <div class="modal-content">
      <h2>Process Prescription</h2>
      <div class="field">
        <label>Patient Name:</label>
        <div id="pharmacyPatientName" style="font-weight:600"></div>
      </div>
      <div class="field">
        <label>Prescription Status:</label>
        <select id="prescriptionStatus">
          <option value="Pending">Pending</option>
          <option value="Completed">Completed</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn secondary" onclick="closePharmacyModal()">Cancel</button>
        <button class="btn primary" onclick="savePrescription()">Save</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const getLS = k => JSON.parse(localStorage.getItem(k)||'[]');
    const setLS = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const pharmacyTableBody = document.querySelector('#pharmacyTable tbody');
    const pharmacyModal = document.getElementById('pharmacyModal');
    const pharmacyPatientName = document.getElementById('pharmacyPatientName');
    const prescriptionStatus = document.getElementById('prescriptionStatus');
    const toast = document.getElementById('toast');
    const userMeta = document.getElementById('userMeta');
    const logged = JSON.parse(localStorage.getItem('loggedInUser')||'null');
    userMeta.innerText = logged ? `Staff: ${logged.username}` : 'Pharmacy';

    let patients = getLS('patients');
    let currentPharmacyIndex = -1;

    function showToast(msg,type='success'){
      toast.innerText = msg;
      toast.className='toast '+(type==='error'?'error':'success');
      toast.style.display='block';
      setTimeout(()=>toast.style.display='none',2600);
    }

    function renderTable(){
      patients = getLS('patients');
      pharmacyTableBody.innerHTML='';

      const pharmacyPatients = patients.filter(p => p.doctor && p.doctor.nextStep==='Pharmacy');

      if(pharmacyPatients.length===0){
        pharmacyTableBody.innerHTML='<tr><td colspan="5" style="text-align:center;color:#9b1c1c">No patients in Pharmacy queue</td></tr>';
        return;
      }

      pharmacyPatients.forEach((p,i)=>{
        const status = p.pharmacy && p.pharmacy.completed ? 'Completed' : 'Pending';
        const tr = document.createElement('tr');
        tr.innerHTML=`
          <td><strong>${p.name}</strong><div class="small-muted">${p.age} yrs</div></td>
          <td>${p.doctor ? p.doctor.diagnosis : '-'}</td>
          <td>${p.doctor ? p.doctor.medicines : '-'}</td>
          <td>${status}</td>
          <td>
            <button class="btn primary" onclick="openPharmacyModal(${patients.indexOf(p)})">Process</button>
          </td>
        `;
        pharmacyTableBody.appendChild(tr);
      });
    }

    function openPharmacyModal(i){
      currentPharmacyIndex = i;
      const p = patients[i];
      pharmacyPatientName.innerText = p.name;
      prescriptionStatus.value = p.pharmacy && p.pharmacy.completed ? 'Completed' : 'Pending';
      pharmacyModal.style.display = 'flex';
    }

    function savePrescription(){
      if(currentPharmacyIndex===-1) return showToast('No patient selected','error');
      const p = patients[currentPharmacyIndex];
      p.pharmacy = { completed: prescriptionStatus.value==='Completed', timestamp: new Date().toISOString() };
      setLS('patients',patients);
      showToast('Prescription updated successfully');
      closePharmacyModal();
      renderTable();
    }

    function closePharmacyModal(){
      pharmacyModal.style.display='none';
      currentPharmacyIndex=-1;
    }

    function logout(){
      localStorage.removeItem('loggedInUser');
      window.location.href='index.html';
    }

    renderTable();
  </script>
</body>
</html>
