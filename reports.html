<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - Prince Alex Hospital</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            overflow-y: auto;
        }

        .sidebar h2 {
            margin-bottom: 2rem;
            text-align: center;
            font-size: 1.2rem;
        }

        .nav-item {
            display: block;
            padding: 12px 16px;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background-color 0.3s ease;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-item i {
            margin-right: 10px;
            width: 20px;
        }

        .main-content {
            margin-left: 250px;
            padding: 2rem;
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 1rem 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            margin-bottom: 1rem;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-success, .btn-info, .btn-warning, .btn-danger {
            transition: all 0.2s ease;
        }

        .loading-indicator {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .report-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .report-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .report-table th,
        .report-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .report-table th {
            background-color: #667eea;
            color: white;
        }

        .report-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-info {
            background: #17a2b8;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .chart-container h3 {
            margin-bottom: 1rem;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .chart {
            width: 100%;
            height: 300px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.1rem;
        }

        .report-section {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .report-section h3 {
            margin-bottom: 1rem;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
        }

        .report-item:last-child {
            border-bottom: none;
        }

        .report-label {
            font-weight: 500;
            color: #555;
        }

        .report-value {
            font-weight: bold;
            color: #667eea;
        }

        .export-section {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .export-section h3 {
            margin-bottom: 1rem;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .export-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: #667eea;
        }

        .loading.show {
            display: block;
        }

        .date-range {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .date-range input {
            padding: 8px;
            border: 2px solid #e1e5e9;
            border-radius: 5px;
        }

        .date-range input:focus {
            outline: none;
            border-color: #667eea;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .summary-card h4 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .summary-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            font-weight: bold;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                padding: 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .date-range {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>🏥 Prince Alex Hospital</h2>
        <nav>
            <a href="reports.html" class="nav-item active">
                <i>📊</i> Reports
            </a>
            <a href="admin.html" class="nav-item">
                <i>👤</i> Admin
            </a>
            <a href="patients.html" class="nav-item">
                <i>🏥</i> Patients
            </a>
            <a href="doctors.html" class="nav-item">
                <i>👨‍⚕️</i> Doctors
            </a>
            <a href="billing.html" class="nav-item">
                <i>💰</i> Billing
            </a>
        </nav>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>Reports & Analytics</h1>
            <div class="user-info">
                <span id="userEmail">Loading...</span>
                <button class="logout-btn" onclick="logout()" aria-label="Logout from the system">Logout</button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator">
            <div class="loading-spinner"></div>
            <p>Loading data...</p>
        </div>

        <!-- Report Modal -->
        <div id="reportModal" class="report-modal">
            <div class="report-modal-content">
                <span class="close" onclick="closeReportModal()" aria-label="Close report modal">&times;</span>
                <h2 id="reportTitle">Report</h2>
                <div id="reportContent"></div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalPatientsCount">0</div>
                <div class="stat-label">Total Patients</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalAppointmentsCount">0</div>
                <div class="stat-label">Total Appointments</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRevenueAmount">$0</div>
                <div class="stat-label">Total Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalStaffCount">0</div>
                <div class="stat-label">Total Staff</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h3>Report Filters</h3>
                <div class="form-group">
                    <label for="reportType">Report Type</label>
                    <select id="reportType">
                        <option value="overview">Overview Report</option>
                        <option value="patients">Patient Report</option>
                        <option value="appointments">Appointment Report</option>
                        <option value="billing">Billing Report</option>
                        <option value="staff">Staff Report</option>
                        <option value="lab">Lab Report</option>
                        <option value="pharmacy">Pharmacy Report</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate">
                    </div>
                </div>
                <div class="form-group">
                    <label for="department">Department</label>
                    <select id="department">
                        <option value="">All Departments</option>
                        <option value="emergency">Emergency</option>
                        <option value="cardiology">Cardiology</option>
                        <option value="neurology">Neurology</option>
                        <option value="orthopedics">Orthopedics</option>
                        <option value="pediatrics">Pediatrics</option>
                        <option value="surgery">Surgery</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="generateReport()">Generate Report</button>
                <button class="btn btn-info" onclick="exportReport()">Export Report</button>
            </div>

            <div class="card">
                <h3>Quick Analytics</h3>
                <div class="report-section">
                    <h4>Today's Summary</h4>
                    <div class="report-item">
                        <span class="report-label">Appointments</span>
                        <span class="report-value" id="todayAppointments">0</span>
                    </div>
                    <div class="report-item">
                        <span class="report-label">New Patients</span>
                        <span class="report-value" id="todayPatients">0</span>
                    </div>
                    <div class="report-item">
                        <span class="report-label">Revenue</span>
                        <span class="report-value" id="todayRevenue">$0</span>
                    </div>
                    <div class="report-item">
                        <span class="report-label">Lab Tests</span>
                        <span class="report-value" id="todayLabTests">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h3>Monthly Trends</h3>
            <div class="chart" id="monthlyChart">
                Monthly trends chart will be displayed here
            </div>
        </div>

        <div class="summary-grid">
            <div class="summary-card">
                <h4>Patient Demographics</h4>
                <div class="summary-item">
                    <span>Male Patients</span>
                    <span id="malePatients">0</span>
                </div>
                <div class="summary-item">
                    <span>Female Patients</span>
                    <span id="femalePatients">0</span>
                </div>
                <div class="summary-item">
                    <span>Average Age</span>
                    <span id="averageAge">0</span>
                </div>
                <div class="summary-item">
                    <span>Total Patients</span>
                    <span id="totalPatientsCount">0</span>
                </div>
            </div>

            <div class="summary-card">
                <h4>Appointment Statistics</h4>
                <div class="summary-item">
                    <span>Scheduled</span>
                    <span id="scheduledAppointments">0</span>
                </div>
                <div class="summary-item">
                    <span>Completed</span>
                    <span id="completedAppointments">0</span>
                </div>
                <div class="summary-item">
                    <span>Cancelled</span>
                    <span id="cancelledAppointments">0</span>
                </div>
                <div class="summary-item">
                    <span>No Shows</span>
                    <span id="noShowAppointments">0</span>
                </div>
            </div>

            <div class="summary-card">
                <h4>Financial Summary</h4>
                <div class="summary-item">
                    <span>Total Revenue</span>
                    <span id="totalRevenueAmount">$0</span>
                </div>
                <div class="summary-item">
                    <span>Pending Payments</span>
                    <span id="pendingPayments">$0</span>
                </div>
                <div class="summary-item">
                    <span>Overdue Payments</span>
                    <span id="overduePayments">$0</span>
                </div>
                <div class="summary-item">
                    <span>Net Revenue</span>
                    <span id="netRevenue">$0</span>
                </div>
            </div>

            <div class="summary-card">
                <h4>Staff Performance</h4>
                <div class="summary-item">
                    <span>Total Staff</span>
                    <span id="totalStaffCount">0</span>
                </div>
                <div class="summary-item">
                    <span>Doctors</span>
                    <span id="totalDoctors">0</span>
                </div>
                <div class="summary-item">
                    <span>Nurses</span>
                    <span id="totalNurses">0</span>
                </div>
                <div class="summary-item">
                    <span>Support Staff</span>
                    <span id="supportStaff">0</span>
                </div>
            </div>
        </div>

        <div class="export-section">
            <h3>Data Export</h3>
            <div class="export-buttons">
                <button class="export-btn" onclick="exportData('patients')" aria-label="Export patients data to JSON file">
                    📊 Export Patients Data
                </button>
                <button class="export-btn" onclick="exportData('appointments')" aria-label="Export appointments data to JSON file">
                    📅 Export Appointments Data
                </button>
                <button class="export-btn" onclick="exportData('billing')" aria-label="Export billing data to JSON file">
                    💰 Export Billing Data
                </button>
                <button class="export-btn" onclick="exportData('lab')" aria-label="Export lab data to JSON file">
                    🧪 Export Lab Data
                </button>
                <button class="export-btn" onclick="exportData('pharmacy')" aria-label="Export pharmacy data to JSON file">
                    💊 Export Pharmacy Data
                </button>
                <button class="export-btn" onclick="exportData('staff')" aria-label="Export staff data to JSON file">
                    👥 Export Staff Data
                </button>
                <button class="export-btn" onclick="exportData('all')" aria-label="Export all hospital data to JSON file">
                    📋 Export All Data
                </button>
            </div>
        </div>

        <div class="loading" id="loading">
            <h3>Generating Report...</h3>
            <p>Please wait while we process your data.</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBYfTWtl-N21DxVATxVnhCofgQsVu3xK4M",
            authDomain: "store-e88d9.firebaseapp.com",
            projectId: "store-e88d9",
            storageBucket: "store-e88d9.appspot.com",
            messagingSenderId: "30797525855",
            appId: "1:30797525855:web:335287605ec648f747fcea"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allData = {
            patients: [],
            appointments: [],
            billing: [],
            staff: [],
            labRequests: [],
            prescriptions: [],
            triage: []
        };
        let isLoading = false;

        // Utility functions
        function showAlert(message, type = 'success') {
            // Create alert element if it doesn't exist
            let alertDiv = document.getElementById('alertMessage');
            if (!alertDiv) {
                alertDiv = document.createElement('div');
                alertDiv.id = 'alertMessage';
                alertDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 5px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    max-width: 400px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                document.body.appendChild(alertDiv);
            }

            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            
            // Set background color based on type
            if (type === 'error') {
                alertDiv.style.background = '#dc3545';
            } else if (type === 'warning') {
                alertDiv.style.background = '#ffc107';
                alertDiv.style.color = '#333';
            } else if (type === 'info') {
                alertDiv.style.background = '#17a2b8';
            } else {
                alertDiv.style.background = '#28a745';
            }

            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        // Safe date conversion for Firestore timestamps
        function safeDateConversion(timestamp) {
            if (!timestamp) return new Date();
            
            // If it's a Firestore Timestamp
            if (timestamp.seconds !== undefined) {
                return new Date(timestamp.seconds * 1000);
            }
            
            // If it's already a Date object
            if (timestamp instanceof Date) {
                return timestamp;
            }
            
            // If it's a string
            if (typeof timestamp === 'string') {
                return new Date(timestamp);
            }
            
            // Fallback
            return new Date();
        }

        // Safe filename generation
        function generateSafeFilename(filename) {
            return filename
                .replace(/[^a-zA-Z0-9\s\-_]/g, '') // Remove special characters
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .toLowerCase();
        }

        // Show loading state
        function showLoading() {
            isLoading = true;
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.style.display = 'block';
            }
        }

        // Hide loading state
        function hideLoading() {
            isLoading = false;
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
        }

        // ESC key support for modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
            }
        });

        // Check authentication
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userEmail').textContent = user.email;
                await loadAllData();
            } else {
                window.location.href = 'index.html';
            }
        });

        // Load all data
        async function loadAllData() {
            try {
                showLoading();
                
                await Promise.all([
                    loadPatients(),
                    loadAppointments(),
                    loadBilling(),
                    loadStaff(),
                    loadLabRequests(),
                    loadPrescriptions(),
                    loadTriage()
                ]);
                
                await loadStats();
                await loadQuickAnalytics();
                await loadSummaryData();
                
                hideLoading();
                showAlert('Data loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading data:', error);
                hideLoading();
                showAlert('Error loading data. Please try again.', 'error');
            }
        }

        // Load patients
        async function loadPatients() {
            try {
                const patientsSnapshot = await getDocs(collection(db, 'patients'));
                allData.patients = [];
                patientsSnapshot.forEach((doc) => {
                    allData.patients.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }

        // Load appointments
        async function loadAppointments() {
            try {
                const appointmentsSnapshot = await getDocs(collection(db, 'appointments'));
                allData.appointments = [];
                appointmentsSnapshot.forEach((doc) => {
                    allData.appointments.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading appointments:', error);
            }
        }

        // Load billing
        async function loadBilling() {
            try {
                const billingSnapshot = await getDocs(collection(db, 'billing'));
                allData.billing = [];
                billingSnapshot.forEach((doc) => {
                    allData.billing.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading billing:', error);
            }
        }

        // Load staff
        async function loadStaff() {
            try {
                const staffSnapshot = await getDocs(collection(db, 'users'));
                allData.staff = [];
                staffSnapshot.forEach((doc) => {
                    allData.staff.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading staff:', error);
            }
        }

        // Load lab requests
        async function loadLabRequests() {
            try {
                const labSnapshot = await getDocs(collection(db, 'labRequests'));
                allData.labRequests = [];
                labSnapshot.forEach((doc) => {
                    allData.labRequests.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading lab requests:', error);
            }
        }

        // Load prescriptions
        async function loadPrescriptions() {
            try {
                const prescriptionsSnapshot = await getDocs(collection(db, 'prescriptions'));
                allData.prescriptions = [];
                prescriptionsSnapshot.forEach((doc) => {
                    allData.prescriptions.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading prescriptions:', error);
            }
        }

        // Load triage
        async function loadTriage() {
            try {
                const triageSnapshot = await getDocs(collection(db, 'triage'));
                allData.triage = [];
                triageSnapshot.forEach((doc) => {
                    allData.triage.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading triage:', error);
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                document.getElementById('totalPatientsCount').textContent = allData.patients.length;
                document.getElementById('totalAppointmentsCount').textContent = allData.appointments.length;
                document.getElementById('totalStaffCount').textContent = allData.staff.length;
                
                const totalRevenue = allData.billing
                    .filter(bill => bill.status === 'paid')
                    .reduce((sum, bill) => sum + (bill.totalAmount || 0), 0);
                document.getElementById('totalRevenueAmount').textContent = `$${totalRevenue.toLocaleString()}`;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load quick analytics
        async function loadQuickAnalytics() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                const todayAppointments = allData.appointments.filter(a => a.appointmentDate === today).length;
                const todayPatients = allData.patients.filter(p => {
                    const createdAt = safeDateConversion(p.createdAt);
                    return createdAt.toISOString().split('T')[0] === today;
                }).length;
                const todayRevenue = allData.billing.filter(b => {
                    if (b.status !== 'paid' || !b.paidAt) return false;
                    const paidAt = safeDateConversion(b.paidAt);
                    return paidAt.toISOString().split('T')[0] === today;
                }).reduce((sum, bill) => sum + (bill.totalAmount || 0), 0);
                const todayLabTests = allData.labRequests.filter(l => {
                    const createdAt = safeDateConversion(l.createdAt);
                    return createdAt.toISOString().split('T')[0] === today;
                }).length;

                document.getElementById('todayAppointments').textContent = todayAppointments;
                document.getElementById('todayPatients').textContent = todayPatients;
                document.getElementById('todayRevenue').textContent = `$${todayRevenue.toLocaleString()}`;
                document.getElementById('todayLabTests').textContent = todayLabTests;
            } catch (error) {
                console.error('Error loading quick analytics:', error);
            }
        }

        // Load summary data
        async function loadSummaryData() {
            try {
                // Patient demographics
                const malePatients = allData.patients.filter(p => p.gender === 'male').length;
                const femalePatients = allData.patients.filter(p => p.gender === 'female').length;
                const averageAge = allData.patients.length > 0 ? 
                    Math.round(allData.patients.reduce((sum, p) => sum + p.age, 0) / allData.patients.length) : 0;

                document.getElementById('malePatients').textContent = malePatients;
                document.getElementById('femalePatients').textContent = femalePatients;
                document.getElementById('averageAge').textContent = averageAge;
                document.getElementById('totalPatientsCount').textContent = allData.patients.length;

                // Appointment statistics
                const scheduledAppointments = allData.appointments.filter(a => a.status === 'scheduled').length;
                const completedAppointments = allData.appointments.filter(a => a.status === 'completed').length;
                const cancelledAppointments = allData.appointments.filter(a => a.status === 'cancelled').length;
                const noShowAppointments = allData.appointments.filter(a => a.status === 'no-show').length;

                document.getElementById('scheduledAppointments').textContent = scheduledAppointments;
                document.getElementById('completedAppointments').textContent = completedAppointments;
                document.getElementById('cancelledAppointments').textContent = cancelledAppointments;
                document.getElementById('noShowAppointments').textContent = noShowAppointments;

                // Financial summary
                const totalRevenueAmount = allData.billing
                    .filter(bill => bill.status === 'paid')
                    .reduce((sum, bill) => sum + (bill.totalAmount || 0), 0);
                const pendingPayments = allData.billing
                    .filter(bill => bill.status === 'pending')
                    .reduce((sum, bill) => sum + (bill.totalAmount || 0), 0);
                const overduePayments = allData.billing
                    .filter(bill => bill.status === 'pending' && new Date(bill.dueDate) < new Date())
                    .reduce((sum, bill) => sum + (bill.totalAmount || 0), 0);

                document.getElementById('totalRevenueAmount').textContent = `$${totalRevenueAmount.toLocaleString()}`;
                document.getElementById('pendingPayments').textContent = `$${pendingPayments.toLocaleString()}`;
                document.getElementById('overduePayments').textContent = `$${overduePayments.toLocaleString()}`;
                document.getElementById('netRevenue').textContent = `$${totalRevenueAmount.toLocaleString()}`;

                // Staff performance
                const totalDoctors = allData.staff.filter(s => s.role === 'doctor').length;
                const totalNurses = allData.staff.filter(s => s.role === 'nurse').length;
                const supportStaff = allData.staff.filter(s => 
                    ['pharmacy', 'lab', 'triage', 'reception'].includes(s.role)
                ).length;

                document.getElementById('totalStaffCount').textContent = allData.staff.length;
                document.getElementById('totalDoctors').textContent = totalDoctors;
                document.getElementById('totalNurses').textContent = totalNurses;
                document.getElementById('supportStaff').textContent = supportStaff;
            } catch (error) {
                console.error('Error loading summary data:', error);
            }
        }

        // Generate report
        window.generateReport = async function() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const department = document.getElementById('department').value;

            if (!reportType) {
                showAlert('Please select a report type.', 'warning');
                return;
            }

            showLoading();

            try {
                let reportData = {};
                
                switch (reportType) {
                    case 'overview':
                        reportData = generateOverviewReport(startDate, endDate);
                        break;
                    case 'patients':
                        reportData = generatePatientReport(startDate, endDate);
                        break;
                    case 'appointments':
                        reportData = generateAppointmentReport(startDate, endDate);
                        break;
                    case 'billing':
                        reportData = generateBillingReport(startDate, endDate);
                        break;
                    case 'staff':
                        reportData = generateStaffReport();
                        break;
                    case 'lab':
                        reportData = generateLabReport(startDate, endDate);
                        break;
                    case 'pharmacy':
                        reportData = generatePharmacyReport(startDate, endDate);
                        break;
                }
                
                displayReport(reportData);
                hideLoading();
                showAlert('Report generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating report:', error);
                hideLoading();
                showAlert('Error generating report. Please try again.', 'error');
            }
        };

        // Generate overview report
        function generateOverviewReport(startDate, endDate) {
            return {
                title: 'Hospital Overview Report',
                period: `${startDate} to ${endDate}`,
                data: {
                    totalPatients: allData.patients.length,
                    totalAppointments: allData.appointments.length,
                    totalRevenue: allData.billing.reduce((sum, b) => sum + (b.totalAmount || 0), 0),
                    totalStaff: allData.staff.length,
                    labTests: allData.labRequests.length,
                    prescriptions: allData.prescriptions.length
                }
            };
        }

        // Generate patient report
        function generatePatientReport(startDate, endDate) {
            const filteredPatients = allData.patients.filter(p => {
                if (!p.createdAt) return false;
                const patientDate = new Date(p.createdAt.seconds * 1000).toISOString().split('T')[0];
                return (!startDate || patientDate >= startDate) && (!endDate || patientDate <= endDate);
            });

            return {
                title: 'Patient Report',
                period: `${startDate} to ${endDate}`,
                data: {
                    newPatients: filteredPatients.length,
                    malePatients: filteredPatients.filter(p => p.gender === 'male').length,
                    femalePatients: filteredPatients.filter(p => p.gender === 'female').length,
                    averageAge: filteredPatients.length > 0 ? 
                        Math.round(filteredPatients.reduce((sum, p) => sum + p.age, 0) / filteredPatients.length) : 0
                }
            };
        }

        // Generate appointment report
        function generateAppointmentReport(startDate, endDate) {
            const filteredAppointments = allData.appointments.filter(a => {
                const appointmentDate = a.appointmentDate;
                return (!startDate || appointmentDate >= startDate) && (!endDate || appointmentDate <= endDate);
            });

            return {
                title: 'Appointment Report',
                period: `${startDate} to ${endDate}`,
                data: {
                    totalAppointments: filteredAppointments.length,
                    scheduled: filteredAppointments.filter(a => a.status === 'scheduled').length,
                    completed: filteredAppointments.filter(a => a.status === 'completed').length,
                    cancelled: filteredAppointments.filter(a => a.status === 'cancelled').length
                }
            };
        }

        // Generate billing report
        function generateBillingReport(startDate, endDate) {
            const filteredBilling = allData.billing.filter(b => {
                if (!b.createdAt) return false;
                const billingDate = new Date(b.createdAt.seconds * 1000).toISOString().split('T')[0];
                return (!startDate || billingDate >= startDate) && (!endDate || billingDate <= endDate);
            });

            return {
                title: 'Billing Report',
                period: `${startDate} to ${endDate}`,
                data: {
                    totalInvoices: filteredBilling.length,
                    totalRevenue: filteredBilling.reduce((sum, b) => sum + (b.totalAmount || 0), 0),
                    paidInvoices: filteredBilling.filter(b => b.status === 'paid').length,
                    pendingInvoices: filteredBilling.filter(b => b.status === 'pending').length
                }
            };
        }

        // Generate staff report
        function generateStaffReport() {
            return {
                title: 'Staff Report',
                period: 'Current',
                data: {
                    totalStaff: allData.staff.length,
                    doctors: allData.staff.filter(s => s.role === 'doctor').length,
                    nurses: allData.staff.filter(s => s.role === 'nurse').length,
                    pharmacy: allData.staff.filter(s => s.role === 'pharmacy').length,
                    lab: allData.staff.filter(s => s.role === 'lab').length,
                    triage: allData.staff.filter(s => s.role === 'triage').length,
                    reception: allData.staff.filter(s => s.role === 'reception').length
                }
            };
        }

        // Generate lab report
        function generateLabReport(startDate, endDate) {
            const filteredLabRequests = allData.labRequests.filter(l => {
                if (!l.createdAt) return false;
                const labDate = new Date(l.createdAt.seconds * 1000).toISOString().split('T')[0];
                return (!startDate || labDate >= startDate) && (!endDate || labDate <= endDate);
            });

            return {
                title: 'Lab Report',
                period: `${startDate} to ${endDate}`,
                data: {
                    totalRequests: filteredLabRequests.length,
                    pending: filteredLabRequests.filter(l => l.status === 'pending').length,
                    completed: filteredLabRequests.filter(l => l.status === 'completed').length,
                    urgent: filteredLabRequests.filter(l => l.priority === 'urgent').length
                }
            };
        }

        // Generate pharmacy report
        function generatePharmacyReport(startDate, endDate) {
            const filteredPrescriptions = allData.prescriptions.filter(p => {
                if (!p.createdAt) return false;
                const prescriptionDate = new Date(p.createdAt.seconds * 1000).toISOString().split('T')[0];
                return (!startDate || prescriptionDate >= startDate) && (!endDate || prescriptionDate <= endDate);
            });

            return {
                title: 'Pharmacy Report',
                period: `${startDate} to ${endDate}`,
                data: {
                    totalPrescriptions: filteredPrescriptions.length,
                    pending: filteredPrescriptions.filter(p => p.status === 'pending').length,
                    dispensed: filteredPrescriptions.filter(p => p.status === 'dispensed').length,
                    cancelled: filteredPrescriptions.filter(p => p.status === 'cancelled').length
                }
            };
        }

        // Display report
        function displayReport(reportData) {
            const modal = document.getElementById('reportModal');
            const title = document.getElementById('reportTitle');
            const content = document.getElementById('reportContent');
            
            title.textContent = reportData.title;
            
            // Create a formatted report display
            let reportHTML = `
                <div class="report-summary">
                    <h3>Report Summary</h3>
                    <p><strong>Period:</strong> ${reportData.period}</p>
                    <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                </div>
            `;
            
            // Add data table if available
            if (reportData.data && typeof reportData.data === 'object') {
                reportHTML += '<table class="report-table">';
                reportHTML += '<thead><tr><th>Metric</th><th>Value</th></tr></thead>';
                reportHTML += '<tbody>';
                
                for (const [key, value] of Object.entries(reportData.data)) {
                    reportHTML += `<tr><td>${key}</td><td>${value}</td></tr>`;
                }
                
                reportHTML += '</tbody></table>';
            }
            
            content.innerHTML = reportHTML;
            modal.style.display = 'block';
        }

        // Close report modal
        window.closeReportModal = function() {
            document.getElementById('reportModal').style.display = 'none';
        };

        // Export report
        window.exportReport = function() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let reportData = {};
            
            switch (reportType) {
                case 'overview':
                    reportData = generateOverviewReport(startDate, endDate);
                    break;
                case 'patients':
                    reportData = generatePatientReport(startDate, endDate);
                    break;
                case 'appointments':
                    reportData = generateAppointmentReport(startDate, endDate);
                    break;
                case 'billing':
                    reportData = generateBillingReport(startDate, endDate);
                    break;
                case 'staff':
                    reportData = generateStaffReport();
                    break;
                case 'lab':
                    reportData = generateLabReport(startDate, endDate);
                    break;
                case 'pharmacy':
                    reportData = generatePharmacyReport(startDate, endDate);
                    break;
            }

            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${reportData.title.toLowerCase().replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        };

        // Export data
        window.exportData = function(dataType) {
            let exportData = {};
            let filename = '';

            switch (dataType) {
                case 'patients':
                    exportData = allData.patients;
                    filename = 'patients-data';
                    break;
                case 'appointments':
                    exportData = allData.appointments;
                    filename = 'appointments-data';
                    break;
                case 'billing':
                    exportData = allData.billing;
                    filename = 'billing-data';
                    break;
                case 'lab':
                    exportData = allData.labRequests;
                    filename = 'lab-data';
                    break;
                case 'pharmacy':
                    exportData = allData.prescriptions;
                    filename = 'pharmacy-data';
                    break;
                case 'staff':
                    exportData = allData.staff;
                    filename = 'staff-data';
                    break;
                case 'all':
                    exportData = allData;
                    filename = 'hospital-data';
                    break;
            }

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const safeFilename = generateSafeFilename(`${filename}-${new Date().toISOString().split('T')[0]}`);
            link.download = `${safeFilename}.json`;
            link.click();
            URL.revokeObjectURL(url);
        };

        // Logout function
        window.logout = async function() {
            try {
                showLoading();
                await signOut(auth);
                // Small delay to prevent flash of unauthenticated content
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 100);
            } catch (error) {
                console.error('Logout error:', error);
                hideLoading();
                showAlert('Error signing out. Please try again.', 'error');
            }
        };
    </script>
</body>
</html>
